2021-10-14 20:26:40 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 12  # bit width of gradients
bitsE = 12 # bit width of errors

bitsR = 12  # bit width of randomizer

lr_schedule = [0,1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.000000
Epoch: 000  Loss: 652.628205 Train: 0.5992 Test: 0.5960 FPS: 7865 
Epoch: 001  Loss: 652.346154 Train: 0.5972 Test: 0.5960 FPS: 11644 
Epoch: 002  Loss: 653.495726 Train: 0.6008 Test: 0.5960 FPS: 11553 S BEST 
Epoch: 003  Loss: 652.372863 Train: 0.5979 Test: 0.5960 FPS: 10824 
Epoch: 004  Loss: 635.793803 Train: 0.5453 Test: 0.4992 FPS: 10582 S BEST 
Epoch: 005  Loss: 618.972222 Train: 0.5154 Test: 0.4385 FPS: 10305 S BEST 
Epoch: 006  Loss: 595.006410 Train: 0.4496 Test: 0.4480 FPS: 10735 
Epoch: 007  Loss: 593.908120 Train: 0.4613 Test: 0.5126 FPS: 10729 
Epoch: 008  Loss: 599.011752 Train: 0.5055 Test: 0.5259 FPS: 11169 
Epoch: 009  Loss: 601.040598 Train: 0.5117 Test: 0.5361 FPS: 11432 
Epoch: 010  Loss: 593.238248 Train: 0.4979 Test: 0.5107 FPS: 11559 
Epoch: 011  Loss: 587.303419 Train: 0.4861 Test: 0.5367 FPS: 11261 
Epoch: 012  Loss: 586.053419 Train: 0.4766 Test: 0.4790 FPS: 11257 
Epoch: 013  Loss: 589.602564 Train: 0.5014 Test: 0.5065 FPS: 11374 
Epoch: 014  Loss: 589.944444 Train: 0.5229 Test: 0.5108 FPS: 11388 
Epoch: 015  Loss: 581.469017 Train: 0.5066 Test: 0.5477 FPS: 11366 
Epoch: 016  Loss: 571.460470 Train: 0.5212 Test: 0.5723 FPS: 11313 
Epoch: 017  Loss: 566.743590 Train: 0.5440 Test: 0.5458 FPS: 11512 
Epoch: 018  Loss: 568.095085 Train: 0.5682 Test: 0.5327 FPS: 11410 
Epoch: 019  Loss: 547.511752 Train: 0.5202 Test: 0.4564 FPS: 11409 
Epoch: 020  Loss: 542.295940 Train: 0.5049 Test: 0.6018 FPS: 10861 
Epoch: 021  Loss: 533.930556 Train: 0.4906 Test: 0.4423 FPS: 11470 
Epoch: 022  Loss: 514.891026 Train: 0.4925 Test: 0.5049 FPS: 11280 
Epoch: 023  Loss: 483.672009 Train: 0.5296 Test: 0.4669 FPS: 11478 
Epoch: 024  Loss: 441.336538 Train: 0.5872 Test: 0.5833 FPS: 11232 
Epoch: 025  Loss: 468.911325 Train: 0.5340 Test: 0.6151 FPS: 11467 
Epoch: 026  Loss: 461.381410 Train: 0.5664 Test: 0.5831 FPS: 11513 
Epoch: 027  Loss: 466.143162 Train: 0.5405 Test: 0.5060 FPS: 11331 
Epoch: 028  Loss: 487.720085 Train: 0.5198 Test: 0.5215 FPS: 11563 
Epoch: 029  Loss: 422.271368 Train: 0.4088 Test: 0.4028 FPS: 11498 S BEST 
Epoch: 030  Loss: 364.044872 Train: 0.3216 Test: 0.3102 FPS: 10561 S BEST 
Epoch: 031  Loss: 342.010684 Train: 0.2867 Test: 0.2759 FPS: 10606 S BEST 
Epoch: 032  Loss: 287.639957 Train: 0.2358 Test: 0.2266 FPS: 10216 S BEST 
Epoch: 033  Loss: 231.506410 Train: 0.1578 Test: 0.1605 FPS: 10635 S BEST 
Epoch: 034  Loss: 187.490385 Train: 0.1116 Test: 0.0716 FPS: 10634 S BEST 
Epoch: 035  Loss: 134.625000 Train: 0.0630 Test: 0.0537 FPS: 10501 S BEST 
Epoch: 036  Loss: nan Train: 0.0901 Test: 1.0000 FPS: 10770 
Epoch: 037  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10983 
Epoch: 038  