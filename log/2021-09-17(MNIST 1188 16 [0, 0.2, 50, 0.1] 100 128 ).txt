2021-09-17 14:23:41 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 8  # bit width of gradients
bitsE = 8 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,0.2, 50, 0.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc/fc1/ [512, 10] Scale:16
CONV: 52000 FC: 529408 Total: 581408
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc_1/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc_1/fc1/ [512, 10] Scale:16

Optimization Start!

lr: 0.000000 -> 0.200000
Epoch: 000  Loss: 706.207265 Train: 0.5759 Test: 0.5698 FPS: 7216 
Epoch: 001  Loss: 666.832265 Train: 0.4802 Test: 0.4196 FPS: 11586 S BEST 
Epoch: 002  Loss: 645.541667 Train: 0.4503 Test: 0.4252 FPS: 11273 
Epoch: 003  Loss: 653.979701 Train: 0.4882 Test: 0.5260 FPS: 11482 
Epoch: 004  Loss: 649.793803 Train: 0.4775 Test: 0.4228 FPS: 11466 
Epoch: 005  Loss: 629.383547 Train: 0.4089 Test: 0.3945 FPS: 10516 S BEST 
Epoch: 006  Loss: 620.099359 Train: 0.3930 Test: 0.3834 FPS: 10994 S BEST 
Epoch: 007  Loss: 615.913462 Train: 0.4137 Test: 0.4338 FPS: 9711 
Epoch: 008  Loss: 600.816239 Train: 0.4444 Test: 0.4217 FPS: 9453 
Epoch: 009  Loss: 595.489316 Train: 0.4200 Test: 0.4459 FPS: 9438 
Epoch: 010  Loss: 598.708333 Train: 0.4538 Test: 0.4798 FPS: 9668 
Epoch: 011  Loss: 597.722222 Train: 0.4805 Test: 0.4988 FPS: 10096 
Epoch: 012  Loss: 575.009615 Train: 0.4586 Test: 0.4677 FPS: 10571 
Epoch: 013  Loss: 554.503205 Train: 0.4813 Test: 0.4356 FPS: 9947 
Epoch: 014  Loss: 554.029915 Train: 0.4929 Test: 0.3941 FPS: 10656 
Epoch: 015  Loss: 545.764957 Train: 0.4604 Test: 0.5079 FPS: 10673 
Epoch: 016  Loss: 516.841880 Train: 0.5514 Test: 0.4953 FPS: 10406 
Epoch: 017  Loss: 490.254274 Train: 0.5380 Test: 0.5075 FPS: 10371 
Epoch: 018  Loss: 534.162393 Train: 0.5109 Test: 0.5454 FPS: 10651 
Epoch: 019  Loss: 392.057692 Train: 0.6308 Test: 0.2014 FPS: 10380 S BEST 
Epoch: 020  Loss: 353.207265 Train: 0.6317 Test: 0.7891 FPS: 10961 
Epoch: 021  Loss: 376.616453 Train: 0.5667 Test: 0.7214 FPS: 10805 
Epoch: 022  Loss: 481.889957 Train: 0.5957 Test: 0.5879 FPS: 11065 
Epoch: 023  Loss: 457.512821 Train: 0.5826 Test: 0.6031 FPS: 10708 
Epoch: 024  Loss: 499.143162 Train: 0.5679 Test: 0.5573 FPS: 10506 
Epoch: 025  Loss: 552.200855 Train: 0.5053 Test: 0.4977 FPS: 10886 
Epoch: 026  Loss: 506.013889 Train: 0.5256 Test: 0.5394 FPS: 10250 
Epoch: 027  Loss: 512.976496 Train: 0.5126 Test: 0.4397 FPS: 10336 
Epoch: 028  Loss: 450.856838 Train: 0.5524 Test: 0.5692 FPS: 10747 
Epoch: 029  Loss: 372.428419 Train: 0.6111 Test: 0.8388 FPS: 11002 
Epoch: 030  Loss: 322.334402 Train: 0.6436 Test: 0.7119 FPS: 10626 
Epoch: 031  Loss: 288.153846 Train: 0.6078 Test: 0.7550 FPS: 10756 
Epoch: 032  Loss: 334.092949 Train: 0.5535 Test: 0.8468 FPS: 10700 
Epoch: 033  Loss: 369.086538 Train: 0.6675 Test: 0.7249 FPS: 11020 
Epoch: 034  Loss: 368.150641 Train: 0.6954 Test: 0.7460 FPS: 10771 
Epoch: 035  Loss: 332.943376 Train: 0.6435 Test: 0.7142 FPS: 10870 
Epoch: 036  Loss: 454.090812 Train: 0.5389 Test: 0.3917 FPS: 10837 
Epoch: 037  Loss: 431.429487 Train: 0.6059 Test: 0.5806 FPS: 10939 
Epoch: 038  Loss: 489.528846 Train: 0.6154 Test: 0.5850 FPS: 10929 
Epoch: 039  Loss: 544.620726 Train: 0.4867 Test: 0.4458 FPS: 11089 
Epoch: 040  Loss: 328.549145 Train: 0.4751 Test: 0.3927 FPS: 11047 
Epoch: 041  Loss: 398.088675 Train: 0.5615 Test: 0.5947 FPS: 11020 
Epoch: 042  Loss: 444.057692 Train: 0.4319 Test: 0.3589 FPS: 11027 
Epoch: 043  Loss: 438.746795 Train: 0.5609 Test: 0.7907 FPS: 10777 
Epoch: 044  Loss: 351.689103 Train: 0.6547 Test: 0.5923 FPS: 10761 
Epoch: 045  Loss: 441.034188 Train: 0.5716 Test: 0.5920 FPS: 10115 
Epoch: 046  Loss: 151.092949 Train: 0.1201 Test: 0.0086 FPS: 10826 S BEST 
Epoch: 047  Loss: nan Train: 0.6555 Test: 1.0000 FPS: 10828 
Epoch: 048  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10303 
Epoch: 049  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11053 
lr: 0.200000 -> 0.100000
Epoch: 050  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11025 
Epoch: 051  