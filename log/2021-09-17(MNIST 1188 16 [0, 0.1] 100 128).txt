2021-09-17 12:18:33 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 8  # bit width of gradients
bitsE = 8 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,0.1]

Epoch = 100

batchSize = 128

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

Time = time.strftime('%Y-%m-%d', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


use_batch_norm = False
lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc/fc1/ [512, 10] Scale:16
CONV: 52000 FC: 529408 Total: 581408
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc_1/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc_1/fc1/ [512, 10] Scale:16

Optimization Start!

lr: 0.000000 -> 0.100000
Epoch: 000  Loss: 680.280983 Train: 0.5316 Test: 0.5324 FPS: 7503 
Epoch: 001  Loss: 681.422009 Train: 0.5349 Test: 0.5324 FPS: 11785 
Epoch: 002  Loss: 673.553419 Train: 0.5133 Test: 0.4299 FPS: 11616 S BEST 
Epoch: 003  Loss: 646.020299 Train: 0.4279 Test: 0.4379 FPS: 11225 
Epoch: 004  Loss: 641.730769 Train: 0.4154 Test: 0.3926 FPS: 11555 S BEST 
Epoch: 005  Loss: 633.699786 Train: 0.3794 Test: 0.3529 FPS: 11277 S BEST 
Epoch: 006  Loss: 625.679487 Train: 0.3427 Test: 0.3453 FPS: 11329 S BEST 
Epoch: 007  Loss: 627.961538 Train: 0.3567 Test: 0.3764 FPS: 11160 
Epoch: 008  Loss: 638.478632 Train: 0.4063 Test: 0.4137 FPS: 11512 
Epoch: 009  Loss: 635.314103 Train: 0.3931 Test: 0.3945 FPS: 11575 
Epoch: 010  Loss: 627.144231 Train: 0.3658 Test: 0.3367 FPS: 11521 S BEST 
Epoch: 011  Loss: 623.264957 Train: 0.3584 Test: 0.3708 FPS: 11101 
Epoch: 012  Loss: 623.992521 Train: 0.3654 Test: 0.3612 FPS: 11390 
Epoch: 013  Loss: 620.065171 Train: 0.3598 Test: 0.4003 FPS: 11416 
Epoch: 014  Loss: 626.846154 Train: 0.3993 Test: 0.3993 FPS: 11316 
Epoch: 015  Loss: 624.396368 Train: 0.4168 Test: 0.4084 FPS: 11152 
Epoch: 016  Loss: 617.000000 Train: 0.4192 Test: 0.4181 FPS: 11324 
Epoch: 017  Loss: 608.176282 Train: 0.4157 Test: 0.4179 FPS: 11337 
Epoch: 018  Loss: 605.500000 Train: 0.4249 Test: 0.3766 FPS: 11464 
Epoch: 019  Loss: 599.916667 Train: 0.4214 Test: 0.4405 FPS: 11392 
Epoch: 020  Loss: 603.631410 Train: 0.4513 Test: 0.4343 FPS: 11159 
Epoch: 021  Loss: 616.286325 Train: 0.4720 Test: 0.4521 FPS: 11319 
Epoch: 022  Loss: 617.097222 Train: 0.4486 Test: 0.4365 FPS: 11290 
Epoch: 023  Loss: 616.315171 Train: 0.4646 Test: 0.4907 FPS: 11133 
Epoch: 024  Loss: 630.533120 Train: 0.4846 Test: 0.4451 FPS: 10711 
Epoch: 025  Loss: 616.415598 Train: 0.4685 Test: 0.5213 FPS: 10879 
Epoch: 026  Loss: 608.662393 Train: 0.4747 Test: 0.4235 FPS: 10980 
Epoch: 027  Loss: 615.821581 Train: 0.4551 Test: 0.4500 FPS: 10918 
Epoch: 028  Loss: 610.479701 Train: 0.4508 Test: 0.4243 FPS: 10955 
Epoch: 029  Loss: 610.164530 Train: 0.4058 Test: 0.3576 FPS: 10426 
Epoch: 030  Loss: 604.852564 Train: 0.3990 Test: 0.4510 FPS: 10595 
Epoch: 031  Loss: 618.387821 Train: 0.4782 Test: 0.4585 FPS: 10546 
Epoch: 032  Loss: 620.341880 Train: 0.4869 Test: 0.5286 FPS: 10194 
Epoch: 033  Loss: 525.012821 Train: 0.5214 Test: 0.4842 FPS: 10666 
Epoch: 034  Loss: 496.431624 Train: 0.5021 Test: 0.6307 FPS: 10833 
Epoch: 035  Loss: 492.137821 Train: 0.5686 Test: 0.4390 FPS: 10512 
Epoch: 036  Loss: 430.547009 Train: 0.6032 Test: 0.3446 FPS: 10316 
Epoch: 037  Loss: 474.527778 Train: 0.5286 Test: 0.5545 FPS: 10828 
Epoch: 038  Loss: 518.111111 Train: 0.5746 Test: 0.6582 FPS: 10867 
Epoch: 039  Loss: 507.457265 Train: 0.5120 Test: 0.4720 FPS: 10986 
Epoch: 040  Loss: 584.092949 Train: 0.4752 Test: 0.4328 FPS: 11292 
Epoch: 041  Loss: 554.313034 Train: 0.4769 Test: 0.8016 FPS: 11332 
Epoch: 042  Loss: 393.241453 Train: 0.6320 Test: 0.6557 FPS: 11350 
Epoch: 043  Loss: 282.179487 Train: 0.5959 Test: 0.7699 FPS: 11064 
Epoch: 044  Loss: 334.985043 Train: 0.5517 Test: 0.4170 FPS: 11267 
Epoch: 045  Loss: 351.278846 Train: 0.4291 Test: 0.0719 FPS: 11337 S BEST 
Epoch: 046  Loss: 179.651709 Train: 0.5408 Test: 0.8390 FPS: 11107 
Epoch: 047  Loss: 373.568376 Train: 0.3873 Test: 0.3783 FPS: 11329 
Epoch: 048  Loss: 303.357906 Train: 0.5719 Test: 0.8477 FPS: 11433 
Epoch: 049  Loss: 327.672009 Train: 0.7132 Test: 0.8580 FPS: 11090 
Epoch: 050  Loss: 179.038462 Train: 0.6495 Test: 0.0433 FPS: 11024 S BEST 
Epoch: 051  Loss: 375.608974 Train: 0.6784 Test: 0.0441 FPS: 10717 
Epoch: 052  Loss: 158.697650 Train: 0.6498 Test: 0.7835 FPS: 11191 
Epoch: 053  Loss: 329.641026 Train: 0.6147 Test: 0.5119 FPS: 11292 
Epoch: 054  Loss: 436.057692 Train: 0.6181 Test: 0.7900 FPS: 11055 
Epoch: 055  Loss: 368.154915 Train: 0.4992 Test: 0.5046 FPS: 11218 
Epoch: 056  Loss: 320.119658 Train: 0.5223 Test: 0.8975 FPS: 10461 
Epoch: 057  Loss: 132.635684 Train: 0.6279 Test: 0.0207 FPS: 10999 S BEST 
Epoch: 058  Loss: 130.960470 Train: 0.7143 Test: 0.8897 FPS: 11103 
Epoch: 059  Loss: 349.233974 Train: 0.6627 Test: 0.8817 FPS: 11269 
Epoch: 060  Loss: 392.415598 Train: 0.7529 Test: 0.8925 FPS: 11296 
Epoch: 061  Loss: 260.814103 Train: 0.6974 Test: 0.8800 FPS: 10595 
Epoch: 062  Loss: 445.261752 Train: 0.4449 Test: 0.2745 FPS: 11044 
Epoch: 063  Loss: 170.439103 Train: 0.1229 Test: 0.0378 FPS: 10506 
Epoch: 064  Loss: nan Train: 0.3634 Test: 1.0000 FPS: 10848 
Epoch: 065  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10725 
Epoch: 066  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10532 
Epoch: 067  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11045 
Epoch: 068  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11178 
Epoch: 069  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10916 
Epoch: 070  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11196 
Epoch: 071  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11095 
Epoch: 072  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11124 
Epoch: 073  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11136 
Epoch: 074  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10842 
Epoch: 075  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10804 
Epoch: 076  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11184 
Epoch: 077  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11193 
Epoch: 078  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11174 
Epoch: 079  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11152 
Epoch: 080  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11162 
Epoch: 081  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11163 
Epoch: 082  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11174 
Epoch: 083  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11167 
Epoch: 084  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10596 
Epoch: 085  