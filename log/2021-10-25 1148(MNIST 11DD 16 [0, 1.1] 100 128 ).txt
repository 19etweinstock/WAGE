2021-10-25 11:48:14 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 8] Scale:8
W: /device:GPU:0 Fc/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 1350 FC: 26280 Total: 27630
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 8] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 630.822650 Train: 0.3674 Test: 0.3720 FPS: 7349 
Epoch: 001  Loss: 630.791667 Train: 0.3699 Test: 0.3720 FPS: 11705 S BEST 
Epoch: 002  Loss: 630.463675 Train: 0.3667 Test: 0.3720 FPS: 10647 
Epoch: 003  Loss: 631.117521 Train: 0.3700 Test: 0.3720 FPS: 11229 S BEST 
Epoch: 004  Loss: 630.819444 Train: 0.3671 Test: 0.3720 FPS: 10735 
Epoch: 005  Loss: 630.085470 Train: 0.3663 Test: 0.3720 FPS: 11203 
Epoch: 006  Loss: 629.087607 Train: 0.3689 Test: 0.3872 FPS: 11568 
Epoch: 007  Loss: 616.907051 Train: 0.3941 Test: 0.3944 FPS: 11639 
Epoch: 008  Loss: 618.005342 Train: 0.4083 Test: 0.4350 FPS: 11362 
Epoch: 009  Loss: 625.380342 Train: 0.4481 Test: 0.4415 FPS: 11522 
Epoch: 010  Loss: 629.017094 Train: 0.4796 Test: 0.4989 FPS: 11290 
Epoch: 011  Loss: 631.893162 Train: 0.5027 Test: 0.5109 FPS: 11067 
Epoch: 012  Loss: 627.096154 Train: 0.4985 Test: 0.5140 FPS: 10774 
Epoch: 013  Loss: 628.954060 Train: 0.5111 Test: 0.5148 FPS: 10933 
Epoch: 014  Loss: 627.886752 Train: 0.5106 Test: 0.5020 FPS: 11298 
Epoch: 015  Loss: 627.941239 Train: 0.5040 Test: 0.5233 FPS: 11421 
Epoch: 016  Loss: 630.331197 Train: 0.5145 Test: 0.5329 FPS: 11284 
Epoch: 017  Loss: 631.991453 Train: 0.5249 Test: 0.5280 FPS: 11300 
Epoch: 018  Loss: 633.780983 Train: 0.5290 Test: 0.5161 FPS: 11270 
Epoch: 019  Loss: 631.508547 Train: 0.5127 Test: 0.5175 FPS: 11284 
Epoch: 020  Loss: 633.436966 Train: 0.5355 Test: 0.5667 FPS: 11492 
Epoch: 021  Loss: 631.025641 Train: 0.5541 Test: 0.5179 FPS: 11433 
Epoch: 022  Loss: 611.761752 Train: 0.4890 Test: 0.4312 FPS: 11488 
Epoch: 023  Loss: 594.806624 Train: 0.4223 Test: 0.4189 FPS: 11394 
Epoch: 024  Loss: 585.183761 Train: 0.4354 Test: 0.4722 FPS: 10846 
Epoch: 025  Loss: 584.939103 Train: 0.4853 Test: 0.4892 FPS: 11259 
Epoch: 026  Loss: 583.620726 Train: 0.4951 Test: 0.5016 FPS: 11527 
Epoch: 027  Loss: 577.985043 Train: 0.4932 Test: 0.5164 FPS: 11598 
Epoch: 028  Loss: 578.487179 Train: 0.5045 Test: 0.5066 FPS: 11514 
Epoch: 029  Loss: 578.151709 Train: 0.5030 Test: 0.4797 FPS: 11364 
Epoch: 030  Loss: 565.744658 Train: 0.4773 Test: 0.4353 FPS: 11624 
Epoch: 031  Loss: 563.504274 Train: 0.4736 Test: 0.4810 FPS: 11429 
Epoch: 032  Loss: 564.573718 Train: 0.4854 Test: 0.4612 FPS: 11496 
Epoch: 033  Loss: 565.254274 Train: 0.4618 Test: 0.4554 FPS: 11451 
Epoch: 034  Loss: 566.723291 Train: 0.4508 Test: 0.4666 FPS: 11422 
Epoch: 035  Loss: 560.618590 Train: 0.4656 Test: 0.4868 FPS: 11564 
Epoch: 036  Loss: 557.756410 Train: 0.5212 Test: 0.5632 FPS: 11495 
Epoch: 037  Loss: 521.823718 Train: 0.5006 Test: 0.4600 FPS: 11070 
Epoch: 038  Loss: 470.820513 Train: 0.3941 Test: 0.2592 FPS: 11521 S BEST 
Epoch: 039  Loss: 314.903846 Train: 0.2398 Test: 0.2282 FPS: 10338 S BEST 
Epoch: 040  Loss: 291.755342 Train: 0.2721 Test: 0.2815 FPS: 10433 
Epoch: 041  Loss: 266.286325 Train: 0.2552 Test: 0.2508 FPS: 10942 
Epoch: 042  Loss: 234.912393 Train: 0.2016 Test: 0.1280 FPS: 11451 S BEST 
Epoch: 043  Loss: 171.529915 Train: 0.1025 Test: 0.0787 FPS: 11239 S BEST 
Epoch: 044  Loss: 137.983974 Train: 0.0723 Test: 0.0625 FPS: 10610 S BEST 
Epoch: 045  Loss: 115.769231 Train: 0.0561 Test: 0.0467 FPS: 10561 S BEST 
Epoch: 046  Loss: 107.672009 Train: 0.0654 Test: 0.0713 FPS: 10636 
Epoch: 047  Loss: 121.936966 Train: 0.0734 Test: 0.0573 FPS: 11050 
Epoch: 048  Loss: 125.440171 Train: 0.0861 Test: 0.0519 FPS: 11118 
Epoch: 049  Loss: 119.056624 Train: 0.0698 Test: 0.0314 FPS: 11410 S BEST 
Epoch: 050  Loss: 126.649573 Train: 0.0558 Test: 0.0353 FPS: 10623 
Epoch: 051  Loss: 111.551282 Train: 0.0507 Test: 0.0379 FPS: 11147 
Epoch: 052  Loss: nan Train: 0.3749 Test: 1.0000 FPS: 11267 
Epoch: 053  