2021-10-25 12:50:00 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 8] Scale:8
W: /device:GPU:0 Fc/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 1350 FC: 26280 Total: 27630
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 8] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 673.794872 Train: 0.6476 Test: 0.6361 FPS: 7865 
Epoch: 001  Loss: 671.764957 Train: 0.6408 Test: 0.6361 FPS: 12570 
Epoch: 002  Loss: 672.090812 Train: 0.6432 Test: 0.6361 FPS: 10927 
Epoch: 003  Loss: 672.758547 Train: 0.6442 Test: 0.6361 FPS: 12230 
Epoch: 004  Loss: 672.644231 Train: 0.6456 Test: 0.6361 FPS: 12393 
Epoch: 005  Loss: 673.061966 Train: 0.6474 Test: 0.6361 FPS: 11605 
Epoch: 006  Loss: 672.232906 Train: 0.6444 Test: 0.6361 FPS: 12554 
Epoch: 007  Loss: 668.774573 Train: 0.6387 Test: 0.5896 FPS: 12494 S BEST 
Epoch: 008  Loss: 608.730769 Train: 0.5417 Test: 0.5137 FPS: 10894 S BEST 
Epoch: 009  Loss: 592.752137 Train: 0.5336 Test: 0.5298 FPS: 10121 
Epoch: 010  Loss: 580.357906 Train: 0.4898 Test: 0.4788 FPS: 10462 S BEST 
Epoch: 011  Loss: 577.342949 Train: 0.4651 Test: 0.4439 FPS: 11338 S BEST 
Epoch: 012  Loss: 578.028846 Train: 0.4622 Test: 0.4454 FPS: 11079 
Epoch: 013  Loss: 578.409188 Train: 0.4591 Test: 0.4721 FPS: 11429 
Epoch: 014  Loss: 573.060897 Train: 0.4398 Test: 0.4472 FPS: 12111 
Epoch: 015  Loss: 573.654915 Train: 0.4541 Test: 0.4229 FPS: 11554 S BEST 
Epoch: 016  Loss: 575.761752 Train: 0.4532 Test: 0.4910 FPS: 11867 
Epoch: 017  Loss: 570.414530 Train: 0.4153 Test: 0.4138 FPS: 12024 S BEST 
Epoch: 018  Loss: 569.711538 Train: 0.4100 Test: 0.3906 FPS: 11124 S BEST 
Epoch: 019  Loss: 574.619658 Train: 0.4298 Test: 0.4737 FPS: 10746 
Epoch: 020  Loss: 586.292735 Train: 0.4738 Test: 0.5184 FPS: 11239 
Epoch: 021  Loss: 581.785256 Train: 0.4760 Test: 0.5116 FPS: 11120 
Epoch: 022  Loss: 575.604701 Train: 0.5191 Test: 0.5793 FPS: 11372 
Epoch: 023  Loss: 569.872863 Train: 0.5343 Test: 0.5252 FPS: 11551 
Epoch: 024  Loss: 572.978632 Train: 0.5544 Test: 0.5412 FPS: 11355 
Epoch: 025  Loss: 573.433761 Train: 0.5805 Test: 0.6026 FPS: 11275 
Epoch: 026  Loss: 581.747863 Train: 0.5764 Test: 0.5393 FPS: 11652 
Epoch: 027  Loss: 582.941239 Train: 0.5694 Test: 0.5582 FPS: 11705 
Epoch: 028  Loss: 571.065171 Train: 0.5383 Test: 0.5321 FPS: 10604 
Epoch: 029  Loss: 567.428419 Train: 0.5510 Test: 0.5929 FPS: 11553 
Epoch: 030  Loss: 574.434829 Train: 0.5732 Test: 0.6020 FPS: 11495 
Epoch: 031  Loss: 570.535256 Train: 0.5498 Test: 0.6246 FPS: 11237 
Epoch: 032  Loss: 573.646368 Train: 0.5793 Test: 0.5955 FPS: 11415 
Epoch: 033  Loss: 569.930556 Train: 0.5742 Test: 0.6736 FPS: 10920 
Epoch: 034  Loss: 552.570513 Train: 0.5647 Test: 0.5694 FPS: 11359 
Epoch: 035  Loss: 531.345085 Train: 0.5104 Test: 0.4595 FPS: 11683 
Epoch: 036  Loss: 545.288462 Train: 0.5435 Test: 0.5690 FPS: 11559 
Epoch: 037  Loss: 540.529915 Train: 0.5937 Test: 0.5763 FPS: 11432 
Epoch: 038  Loss: 532.612179 Train: 0.6055 Test: 0.6661 FPS: 11625 
Epoch: 039  Loss: 537.910256 Train: 0.6210 Test: 0.6431 FPS: 11710 
Epoch: 040  Loss: 536.504274 Train: 0.6340 Test: 0.6695 FPS: 11549 
Epoch: 041  Loss: 531.477564 Train: 0.6162 Test: 0.6447 FPS: 11661 
Epoch: 042  Loss: 524.032051 Train: 0.5996 Test: 0.5403 FPS: 11506 
Epoch: 043  Loss: 543.963675 Train: 0.5735 Test: 0.6137 FPS: 11449 
Epoch: 044  Loss: 548.133547 Train: 0.5923 Test: 0.5844 FPS: 11326 
Epoch: 045  Loss: 537.412393 Train: 0.5909 Test: 0.6281 FPS: 11011 
Epoch: 046  Loss: 527.585470 Train: 0.5543 Test: 0.5135 FPS: 10925 
Epoch: 047  Loss: 531.214744 Train: 0.4820 Test: 0.4633 FPS: 11340 
Epoch: 048  Loss: 508.319444 Train: 0.3965 Test: 0.3651 FPS: 11320 S BEST 
Epoch: 049  Loss: 437.414530 Train: 0.3442 Test: 0.2312 FPS: 10442 S BEST 
Epoch: 050  Loss: 371.059829 Train: 0.2285 Test: 0.2334 FPS: 10111 
Epoch: 051  Loss: 243.083333 Train: 0.1372 Test: 0.1545 FPS: 10637 S BEST 
Epoch: 052  Loss: 212.107906 Train: 0.1408 Test: 0.1576 FPS: 10630 
Epoch: 053  Loss: 195.009615 Train: 0.1377 Test: 0.1039 FPS: 11087 S BEST 
Epoch: 054  Loss: 170.168803 Train: 0.1409 Test: 0.1367 FPS: 10778 
Epoch: 055  Loss: 156.189103 Train: 0.1389 Test: 0.1601 FPS: 10729 
Epoch: 056  Loss: 152.728632 Train: 0.1054 Test: 0.0153 FPS: 11481 S BEST 
Epoch: 057  Loss: nan Train: 0.8782 Test: 1.0000 FPS: 10403 
Epoch: 058  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11000 
Epoch: 059  