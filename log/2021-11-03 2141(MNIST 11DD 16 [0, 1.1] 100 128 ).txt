2021-11-03 21:41:00 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/2021-10-25 1108(MNIST 11DD 16 [0, 1.1] 100 128 ).tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 5] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 5, 8] Scale:8
W: /device:GPU:0 Fc/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 1125 FC: 26280 Total: 27405
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 5] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 5, 8] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 618.350427 Train: 0.3630 Test: 0.3567 FPS: 7609 
Epoch: 001  Loss: 618.565171 Train: 0.3639 Test: 0.3567 FPS: 11845 S BEST 
Epoch: 002  Loss: 618.617521 Train: 0.3644 Test: 0.3567 FPS: 11040 S BEST 
Epoch: 003  Loss: 618.213675 Train: 0.3635 Test: 0.3567 FPS: 11034 
Epoch: 004  Loss: 618.297009 Train: 0.3630 Test: 0.3567 FPS: 12008 
Epoch: 005  Loss: 618.381410 Train: 0.3656 Test: 0.3567 FPS: 12079 S BEST 
Epoch: 006  Loss: 618.477564 Train: 0.3618 Test: 0.3567 FPS: 12048 
Epoch: 007  Loss: 618.607906 Train: 0.3656 Test: 0.3573 FPS: 12001 
Epoch: 008  Loss: 617.582265 Train: 0.3604 Test: 0.3573 FPS: 11742 
Epoch: 009  Loss: 614.454060 Train: 0.3955 Test: 0.4688 FPS: 11858 
Epoch: 010  Loss: 618.184829 Train: 0.4999 Test: 0.5549 FPS: 11999 
Epoch: 011  Loss: 620.902778 Train: 0.5401 Test: 0.5974 FPS: 12064 
Epoch: 012  Loss: 607.948718 Train: 0.5548 Test: 0.4765 FPS: 12022 
Epoch: 013  Loss: 577.534188 Train: 0.5044 Test: 0.4834 FPS: 12105 
Epoch: 014  Loss: 582.879274 Train: 0.5226 Test: 0.4605 FPS: 12106 
Epoch: 015  Loss: 584.976496 Train: 0.5299 Test: 0.5087 FPS: 11989 
Epoch: 016  Loss: 577.239316 Train: 0.4982 Test: 0.5386 FPS: 11919 
Epoch: 017  Loss: 587.528846 Train: 0.4956 Test: 0.5352 FPS: 11898 
Epoch: 018  Loss: 588.646368 Train: 0.4974 Test: 0.5161 FPS: 12070 
Epoch: 019  Loss: 591.297009 Train: 0.5091 Test: 0.5267 FPS: 11989 
Epoch: 020  Loss: 594.447650 Train: 0.5464 Test: 0.5277 FPS: 12020 
Epoch: 021  Loss: 590.745726 Train: 0.5526 Test: 0.4941 FPS: 11599 
Epoch: 022  Loss: 577.100427 Train: 0.5105 Test: 0.4969 FPS: 11457 
Epoch: 023  Loss: 569.866453 Train: 0.4732 Test: 0.4444 FPS: 11722 
Epoch: 024  Loss: 560.213675 Train: 0.4118 Test: 0.4374 FPS: 12002 
Epoch: 025  Loss: 560.508547 Train: 0.4274 Test: 0.4695 FPS: 11888 
Epoch: 026  Loss: 571.701923 Train: 0.4973 Test: 0.5735 FPS: 11926 
Epoch: 027  Loss: 580.903846 Train: 0.5679 Test: 0.6066 FPS: 11910 
Epoch: 028  Loss: 574.939103 Train: 0.6080 Test: 0.6119 FPS: 12032 
Epoch: 029  Loss: 580.301282 Train: 0.5242 Test: 0.4846 FPS: 11850 
Epoch: 030  Loss: 576.900641 Train: 0.5102 Test: 0.5669 FPS: 11914 
Epoch: 031  Loss: 615.247863 Train: 0.5755 Test: 0.5937 FPS: 11928 
Epoch: 032  Loss: 616.463675 Train: 0.5777 Test: 0.5844 FPS: 11941 
Epoch: 033  Loss: 592.752137 Train: 0.6145 Test: 0.5693 FPS: 11860 
Epoch: 034  Loss: 569.813034 Train: 0.6251 Test: 0.5641 FPS: 11197 
Epoch: 035  Loss: 585.112179 Train: 0.7061 Test: 0.5387 FPS: 11722 
Epoch: 036  Loss: 638.547009 Train: 0.7009 Test: 0.5737 FPS: 12021 
Epoch: 037  Loss: 397.400641 Train: 0.7338 Test: 0.5737 FPS: 12004 
Epoch: 038  Loss: 536.612179 Train: 0.4031 Test: 0.4894 FPS: 12025 
Epoch: 039  Loss: 332.829060 Train: 0.4831 Test: 0.5306 FPS: 11929 
Epoch: 040  Loss: 225.927350 Train: 0.6901 Test: 0.5297 FPS: 12037 
Epoch: 041  Loss: 337.774573 Train: 0.5992 Test: 0.5325 FPS: 12069 
Epoch: 042  Loss: 329.836538 Train: 0.6371 Test: 0.5620 FPS: 12080 
Epoch: 043  Loss: 215.611111 Train: 0.7546 Test: 0.5822 FPS: 12018 
Epoch: 044  Loss: 138.309829 Train: 0.8549 Test: 0.5895 FPS: 12037 
Epoch: 045  Loss: 137.665598 Train: 0.8589 Test: 0.5596 FPS: 12066 
Epoch: 046  Loss: 136.692308 Train: 0.8565 Test: 0.5322 FPS: 12023 
Epoch: 047  Loss: 137.837607 Train: 0.8587 Test: 0.5682 FPS: 11559 
Epoch: 048  Loss: 156.526709 Train: 0.4582 Test: 0.5367 FPS: 11910 
Epoch: 049  Loss: 170.028846 Train: 0.4188 Test: 0.5646 FPS: 12164 
Epoch: 050  Loss: 174.113248 Train: 0.4148 Test: 0.5828 FPS: 12048 
Epoch: 051  Loss: 174.899573 Train: 0.4023 Test: 0.5701 FPS: 12086 
Epoch: 052  Loss: 173.779915 Train: 0.3982 Test: 0.5184 FPS: 12127 
Epoch: 053  Loss: 198.478632 Train: 0.4534 Test: 0.5615 FPS: 12138 
Epoch: 054  Loss: 252.950855 Train: 0.7740 Test: 0.5600 FPS: 11973 
Epoch: 055  Loss: 309.202991 Train: 0.3833 Test: 0.5359 FPS: 11596 
Epoch: 056  Loss: 401.536325 Train: 0.3773 Test: 0.5609 FPS: 11802 
Epoch: 057  Loss: 389.816239 Train: 0.4006 Test: 0.5458 FPS: 11773 
Epoch: 058  Loss: 293.483974 Train: 0.5805 Test: 0.5901 FPS: 11786 
Epoch: 059  Loss: 324.586538 Train: 0.7419 Test: 0.5989 FPS: 11882 
Epoch: 060  Loss: 425.142094 Train: 0.7497 Test: 0.6356 FPS: 11260 
Epoch: 061  Loss: 404.260684 Train: 0.6730 Test: 0.5915 FPS: 11625 
Epoch: 062  Loss: 478.553419 Train: 0.5728 Test: 0.7210 FPS: 11865 
Epoch: 063  Loss: 460.829060 Train: 0.6837 Test: 0.6788 FPS: 11893 
Epoch: 064  Loss: 553.835470 Train: 0.7817 Test: 0.6628 FPS: 12086 
Epoch: 065  Loss: 519.051282 Train: 0.7315 Test: 0.7183 FPS: 12164 
Epoch: 066  Loss: 475.495726 Train: 0.8001 Test: 0.6972 FPS: 12202 
Epoch: 067  Loss: 443.085470 Train: 0.7204 Test: 0.7047 FPS: 12095 
Epoch: 068  Loss: 412.223291 Train: 0.6433 Test: 0.6631 FPS: 12011 
Epoch: 069  Loss: 459.544872 Train: 0.5341 Test: 0.6039 FPS: 11877 
Epoch: 070  Loss: 476.974359 Train: 0.5712 Test: 0.5759 FPS: 11767 
Epoch: 071  Loss: 608.930556 Train: 0.6774 Test: 0.5997 FPS: 11893 
Epoch: 072  Loss: 330.283120 Train: 0.6948 Test: 0.5703 FPS: 11964 
Epoch: 073  Loss: 514.726496 Train: 0.5452 Test: 0.6761 FPS: 10970 
Epoch: 074  Loss: 475.070513 Train: 0.6587 Test: 0.7280 FPS: 11387 
Epoch: 075  Loss: 474.925214 Train: 0.6775 Test: 0.7480 FPS: 11408 
Epoch: 076  Loss: 597.996795 Train: 0.6524 Test: 0.6508 FPS: 11677 
Epoch: 077  Loss: nan Train: 0.5801 Test: 1.0000 FPS: 11931 
Epoch: 078  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11903 
Epoch: 079  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11614 
Epoch: 080  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11721 
Epoch: 081  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11618 
Epoch: 082  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11295 
Epoch: 083  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11294 
Epoch: 084  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11754 
Epoch: 085  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11706 
Epoch: 086  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11518 
Epoch: 087  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11779 
Epoch: 088  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11609 
Epoch: 089  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11704 
Epoch: 090  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11632 
Epoch: 091  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11398 
Epoch: 092  