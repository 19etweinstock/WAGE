2021-11-05 13:45:46 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/2021-10-25 1108(MNIST 11DD 16 [0, 1.1] 100 128 ).tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 8] Scale:8
W: /device:GPU:0 Fc/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 1350 FC: 26280 Total: 27630
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 8] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 636.655983 Train: 0.3841 Test: 0.3855 FPS: 8218 
Epoch: 001  Loss: 636.570513 Train: 0.3833 Test: 0.3855 FPS: 12840 
Epoch: 002  Loss: 637.392094 Train: 0.3867 Test: 0.3855 FPS: 12957 S BEST 
Epoch: 003  Loss: 636.728632 Train: 0.3848 Test: 0.3855 FPS: 11800 
Epoch: 004  Loss: 636.498932 Train: 0.3824 Test: 0.3855 FPS: 12054 
Epoch: 005  Loss: 636.278846 Train: 0.3824 Test: 0.3855 FPS: 12594 
Epoch: 006  Loss: 636.785256 Train: 0.3850 Test: 0.3855 FPS: 12528 
Epoch: 007  Loss: 634.684829 Train: 0.3901 Test: 0.3945 FPS: 12489 
Epoch: 008  Loss: 627.655983 Train: 0.4270 Test: 0.4215 FPS: 12199 
Epoch: 009  Loss: 601.202991 Train: 0.4314 Test: 0.4413 FPS: 12347 
Epoch: 010  Loss: 601.119658 Train: 0.4447 Test: 0.4419 FPS: 12251 
Epoch: 011  Loss: 601.050214 Train: 0.4521 Test: 0.4561 FPS: 10898 
Epoch: 012  Loss: 600.493590 Train: 0.4493 Test: 0.4397 FPS: 11110 
Epoch: 013  Loss: 600.862179 Train: 0.4430 Test: 0.4464 FPS: 11602 
Epoch: 014  Loss: 603.690171 Train: 0.4499 Test: 0.4482 FPS: 11834 
Epoch: 015  Loss: 603.780983 Train: 0.4816 Test: 0.5480 FPS: 11943 
Epoch: 016  Loss: 611.105769 Train: 0.5533 Test: 0.5631 FPS: 12350 
Epoch: 017  Loss: 600.144231 Train: 0.5231 Test: 0.5469 FPS: 11737 
Epoch: 018  Loss: 599.724359 Train: 0.5373 Test: 0.5488 FPS: 11821 
Epoch: 019  Loss: 605.810897 Train: 0.5530 Test: 0.5698 FPS: 11973 
Epoch: 020  Loss: 602.736111 Train: 0.5435 Test: 0.5256 FPS: 11781 
Epoch: 021  Loss: 588.909188 Train: 0.5025 Test: 0.5104 FPS: 11981 
Epoch: 022  Loss: 590.940171 Train: 0.4918 Test: 0.4701 FPS: 11968 
Epoch: 023  Loss: 582.341880 Train: 0.4759 Test: 0.4400 FPS: 11932 
Epoch: 024  Loss: 577.278846 Train: 0.4959 Test: 0.5041 FPS: 11874 
Epoch: 025  Loss: 577.994658 Train: 0.5103 Test: 0.5034 FPS: 11697 
Epoch: 026  Loss: 576.410256 Train: 0.5033 Test: 0.5023 FPS: 11825 
Epoch: 027  Loss: 573.114316 Train: 0.4728 Test: 0.4406 FPS: 11756 
Epoch: 028  Loss: 571.200855 Train: 0.4420 Test: 0.4530 FPS: 11957 
Epoch: 029  Loss: 559.962607 Train: 0.4433 Test: 0.4065 FPS: 11595 
Epoch: 030  Loss: 551.872863 Train: 0.4147 Test: 0.4428 FPS: 11790 
Epoch: 031  Loss: 563.159188 Train: 0.4964 Test: 0.4918 FPS: 11628 
Epoch: 032  Loss: 552.050214 Train: 0.5199 Test: 0.5515 FPS: 11837 
Epoch: 033  Loss: 530.386752 Train: 0.5925 Test: 0.7119 FPS: 11712 
Epoch: 034  Loss: 458.094017 Train: 0.6916 Test: 0.4308 FPS: 11845 
Epoch: 035  Loss: 440.049145 Train: 0.6209 Test: 0.2505 FPS: 11787 S BEST 
Epoch: 036  Loss: 488.872863 Train: 0.7162 Test: 0.6086 FPS: 10847 
Epoch: 037  Loss: 462.465812 Train: 0.5501 Test: 0.4522 FPS: 10777 
Epoch: 038  Loss: 439.208333 Train: 0.5285 Test: 0.5169 FPS: 11671 
Epoch: 039  Loss: 314.021368 Train: 0.6739 Test: 0.1899 FPS: 11738 S BEST 
Epoch: 040  Loss: 222.132479 Train: 0.6346 Test: 0.8533 FPS: 10938 
Epoch: 041  Loss: 264.524573 Train: 0.5606 Test: 0.4748 FPS: 11390 
Epoch: 042  Loss: 424.782051 Train: 0.6678 Test: 0.6020 FPS: 11627 
Epoch: 043  Loss: 369.044872 Train: 0.6721 Test: 0.6925 FPS: 11619 
Epoch: 044  Loss: 387.802350 Train: 0.5488 Test: 0.5346 FPS: 11421 
Epoch: 045  Loss: 423.420940 Train: 0.4759 Test: 0.4359 FPS: 11468 
Epoch: 046  Loss: 435.744658 Train: 0.4543 Test: 0.4077 FPS: 10868 
Epoch: 047  Loss: 480.339744 Train: 0.3569 Test: 0.3037 FPS: 11112 
Epoch: 048  Loss: 448.865385 Train: 0.4438 Test: 0.4916 FPS: 11586 
Epoch: 049  Loss: 449.353632 Train: 0.4517 Test: 0.2947 FPS: 11410 
Epoch: 050  Loss: 390.080128 Train: 0.5784 Test: 0.5639 FPS: 11570 
Epoch: 051  Loss: 504.821581 Train: 0.5993 Test: 0.5938 FPS: 11804 
Epoch: 052  Loss: 564.146368 Train: 0.5738 Test: 0.5526 FPS: 11669 
Epoch: 053  Loss: 532.879274 Train: 0.6155 Test: 0.6486 FPS: 11622 
Epoch: 054  Loss: 502.000000 Train: 0.6198 Test: 0.4692 FPS: 11748 
Epoch: 055  Loss: 512.146368 Train: 0.4886 Test: 0.6125 FPS: 11549 
Epoch: 056  Loss: 468.885684 Train: 0.5926 Test: 0.6314 FPS: 11526 
Epoch: 057  Loss: 535.334402 Train: 0.5458 Test: 0.5832 FPS: 11708 
Epoch: 058  Loss: 414.175214 Train: 0.5472 Test: 0.4541 FPS: 11532 
Epoch: 059  Loss: 435.231838 Train: 0.5927 Test: 0.5865 FPS: 11542 
Epoch: 060  Loss: 450.915598 Train: 0.6297 Test: 0.6897 FPS: 11714 
Epoch: 061  Loss: 428.602564 Train: 0.6224 Test: 0.5671 FPS: 11582 
Epoch: 062  Loss: 519.055556 Train: 0.5779 Test: 0.6139 FPS: 11100 
Epoch: 063  Loss: 510.880342 Train: 0.5965 Test: 0.6015 FPS: 11664 
Epoch: 064  Loss: 512.895299 Train: 0.6117 Test: 0.6271 FPS: 11596 
Epoch: 065  Loss: 514.164530 Train: 0.6508 Test: 0.6567 FPS: 11568 
Epoch: 066  Loss: 518.108974 Train: 0.6409 Test: 0.6442 FPS: 11809 
Epoch: 067  Loss: 505.114316 Train: 0.6472 Test: 0.6925 FPS: 11648 
Epoch: 068  Loss: 439.063034 Train: 0.6379 Test: 0.6672 FPS: 11485 
Epoch: 069  Loss: 389.995726 Train: 0.5182 Test: 0.6795 FPS: 11539 
Epoch: 070  Loss: 373.751068 Train: 0.4715 Test: 0.6076 FPS: 11507 
Epoch: 071  Loss: 337.288462 Train: 0.4486 Test: 0.2005 FPS: 11127 
Epoch: 072  Loss: 273.660256 Train: 0.3752 Test: 0.5532 FPS: 11546 
Epoch: 073  Loss: 289.382479 Train: 0.4327 Test: 0.5126 FPS: 11606 
Epoch: 074  Loss: 213.938034 Train: 0.3221 Test: 0.0932 FPS: 11126 S BEST 
Epoch: 075  Loss: 203.925214 Train: 0.2598 Test: 0.0883 FPS: 10319 S BEST 
Epoch: 076  Loss: 141.997863 Train: 0.0807 Test: 0.1704 FPS: 10530 
Epoch: 077  Loss: 123.038462 Train: 0.0893 Test: 1.0000 FPS: 11458 
Epoch: 078  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11492 
Epoch: 079  