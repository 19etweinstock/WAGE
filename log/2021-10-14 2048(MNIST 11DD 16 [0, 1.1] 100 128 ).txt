2021-10-14 20:48:16 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 646.243590 Train: 0.4298 Test: 0.4341 FPS: 7345 
Epoch: 001  Loss: 645.042735 Train: 0.4272 Test: 0.4341 FPS: 10565 
Epoch: 002  Loss: 645.648504 Train: 0.4285 Test: 0.4341 FPS: 11424 
Epoch: 003  Loss: 645.436966 Train: 0.4272 Test: 0.4341 FPS: 11541 
Epoch: 004  Loss: 645.994658 Train: 0.4296 Test: 0.4341 FPS: 11601 
Epoch: 005  Loss: 645.544872 Train: 0.4278 Test: 0.4341 FPS: 11578 
Epoch: 006  Loss: 645.886752 Train: 0.4287 Test: 0.4341 FPS: 11650 
Epoch: 007  Loss: 635.629274 Train: 0.4069 Test: 0.3894 FPS: 11364 S BEST 
Epoch: 008  Loss: 623.371795 Train: 0.3928 Test: 0.4026 FPS: 10814 
Epoch: 009  Loss: 614.580128 Train: 0.4092 Test: 0.4153 FPS: 10297 
Epoch: 010  Loss: 603.455128 Train: 0.4185 Test: 0.4231 FPS: 11335 
Epoch: 011  Loss: 599.943376 Train: 0.4139 Test: 0.4229 FPS: 10593 
Epoch: 012  Loss: 602.936966 Train: 0.4528 Test: 0.4672 FPS: 10396 
Epoch: 013  Loss: 583.927350 Train: 0.4210 Test: 0.4115 FPS: 10671 
Epoch: 014  Loss: 586.948718 Train: 0.4334 Test: 0.4240 FPS: 10944 
Epoch: 015  Loss: 589.101496 Train: 0.4742 Test: 0.5413 FPS: 10893 
Epoch: 016  Loss: 594.510684 Train: 0.5065 Test: 0.4737 FPS: 10905 
Epoch: 017  Loss: 602.480769 Train: 0.5301 Test: 0.5373 FPS: 10760 
Epoch: 018  Loss: 602.976496 Train: 0.5330 Test: 0.5334 FPS: 10965 
Epoch: 019  Loss: 603.965812 Train: 0.5485 Test: 0.5653 FPS: 11186 
Epoch: 020  Loss: 606.064103 Train: 0.5844 Test: 0.5988 FPS: 11319 
Epoch: 021  Loss: 605.413462 Train: 0.5994 Test: 0.6001 FPS: 11135 
Epoch: 022  Loss: 609.488248 Train: 0.6093 Test: 0.6088 FPS: 11331 
Epoch: 023  Loss: 593.731838 Train: 0.5825 Test: 0.5437 FPS: 11543 
Epoch: 024  Loss: 569.638889 Train: 0.5619 Test: 0.5741 FPS: 11181 
Epoch: 025  Loss: 564.178419 Train: 0.5637 Test: 0.5287 FPS: 11573 
Epoch: 026  Loss: 556.521368 Train: 0.5392 Test: 0.5973 FPS: 11460 
Epoch: 027  Loss: 562.967949 Train: 0.5765 Test: 0.6002 FPS: 11056 
Epoch: 028  Loss: 559.972222 Train: 0.5537 Test: 0.5594 FPS: 11436 
Epoch: 029  Loss: 573.227564 Train: 0.5875 Test: 0.6203 FPS: 11830 
Epoch: 030  Loss: 586.318376 Train: 0.6402 Test: 0.6182 FPS: 11272 
Epoch: 031  Loss: 579.170940 Train: 0.6447 Test: 0.6067 FPS: 11510 
Epoch: 032  Loss: 571.938034 Train: 0.6496 Test: 0.6624 FPS: 11735 
Epoch: 033  Loss: 562.574786 Train: 0.6326 Test: 0.6255 FPS: 11146 
Epoch: 034  Loss: 561.909188 Train: 0.6324 Test: 0.6321 FPS: 11318 
Epoch: 035  Loss: 550.868590 Train: 0.6145 Test: 0.5386 FPS: 11157 
Epoch: 036  Loss: 542.409188 Train: 0.5619 Test: 0.5495 FPS: 10980 
Epoch: 037  Loss: 536.043803 Train: 0.5497 Test: 0.4445 FPS: 10774 
Epoch: 038  Loss: 516.592949 Train: 0.5149 Test: 0.4887 FPS: 11836 
Epoch: 039  Loss: 505.495726 Train: 0.5166 Test: 0.4845 FPS: 11082 
Epoch: 040  Loss: 504.893162 Train: 0.5184 Test: 0.5378 FPS: 11417 
Epoch: 041  Loss: 497.848291 Train: 0.5434 Test: 0.5713 FPS: 11058 
Epoch: 042  Loss: 496.501068 Train: 0.5529 Test: 0.6089 FPS: 11142 
Epoch: 043  Loss: 508.240385 Train: 0.5404 Test: 0.5109 FPS: 11129 
Epoch: 044  Loss: 511.135684 Train: 0.5412 Test: 0.4840 FPS: 10887 
Epoch: 045  Loss: 517.900641 Train: 0.5306 Test: 0.5522 FPS: 11019 
Epoch: 046  Loss: 512.459402 Train: 0.5383 Test: 0.5905 FPS: 11664 
Epoch: 047  Loss: 520.058761 Train: 0.5431 Test: 0.5878 FPS: 11047 
Epoch: 048  Loss: 496.070513 Train: 0.5661 Test: 0.6381 FPS: 10800 
Epoch: 049  Loss: 481.789530 Train: 0.5454 Test: 0.6396 FPS: 11025 
Epoch: 050  Loss: 459.929487 Train: 0.5271 Test: 0.4770 FPS: 11273 
Epoch: 051  Loss: 457.871795 Train: 0.5236 Test: 0.6213 FPS: 10979 
Epoch: 052  Loss: 458.751068 Train: 0.5556 Test: 0.6475 FPS: 11315 
Epoch: 053  Loss: 445.754274 Train: 0.6022 Test: 0.4515 FPS: 10586 
Epoch: 054  Loss: 441.181624 Train: 0.6141 Test: 0.5883 FPS: 11660 
Epoch: 055  Loss: 431.371795 Train: 0.6185 Test: 0.4625 FPS: 11732 
Epoch: 056  Loss: 430.261752 Train: 0.6205 Test: 0.4964 FPS: 10798 
Epoch: 057  Loss: 475.229701 Train: 0.5943 Test: 0.5704 FPS: 10705 
Epoch: 058  Loss: 478.317308 Train: 0.5973 Test: 0.5718 FPS: 11210 
Epoch: 059  Loss: 486.873932 Train: 0.6179 Test: 0.5905 FPS: 11338 
Epoch: 060  Loss: 502.536325 Train: 0.6465 Test: 0.6370 FPS: 11214 
Epoch: 061  Loss: 489.464744 Train: 0.6395 Test: 0.6232 FPS: 10654 
Epoch: 062  Loss: 489.605769 Train: 0.5799 Test: 0.5659 FPS: 10901 
Epoch: 063  Loss: 476.879274 Train: 0.5994 Test: 0.4940 FPS: 11239 
Epoch: 064  Loss: 451.608974 Train: 0.5967 Test: 0.5847 FPS: 11381 
Epoch: 065  Loss: 463.401709 Train: 0.6146 Test: 0.6185 FPS: 11312 
Epoch: 066  Loss: 442.276709 Train: 0.5777 Test: 0.5383 FPS: 10865 
Epoch: 067  Loss: 375.315171 Train: 0.4252 Test: 0.2751 FPS: 10587 S BEST 
Epoch: 068  Loss: 330.256410 Train: 0.2911 Test: 0.2384 FPS: 10493 S BEST 
Epoch: 069  Loss: 288.535256 Train: 0.2336 Test: 0.1889 FPS: 10450 S BEST 
Epoch: 070  Loss: 248.636752 Train: 0.1744 Test: 0.1682 FPS: 10881 S BEST 
Epoch: 071  Loss: 236.252137 Train: 0.1558 Test: 0.1595 FPS: 11069 S BEST 
Epoch: 072  Loss: 206.684829 Train: 0.1314 Test: 0.1109 FPS: 10700 S BEST 
Epoch: 073  Loss: 158.599359 Train: 0.0848 Test: 0.0600 FPS: 10293 S BEST 
Epoch: 074  Loss: 110.551282 Train: 0.0404 Test: 0.0234 FPS: 10554 S BEST 
Epoch: 075  Loss: nan Train: 0.8810 Test: 1.0000 FPS: 10374 
Epoch: 076  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10969 
Epoch: 077  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10953 
Epoch: 078  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10607 
Epoch: 079  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11438 
Epoch: 080  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10522 
Epoch: 081  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10917 
Epoch: 082  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11247 
Epoch: 083  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10872 
Epoch: 084  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10352 
Epoch: 085  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10815 
Epoch: 086  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11611 
Epoch: 087  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11414 
Epoch: 088  