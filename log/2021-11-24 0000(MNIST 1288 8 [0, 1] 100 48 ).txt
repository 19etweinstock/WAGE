2021-11-24 00:00:51 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 2  # bit width of activations
bitsG = 8  # bit width of gradients
bitsE = 8 # bit width of errors

bitsR = 8  # bit width of randomizer

lr_schedule = [0,1]

Epoch = 100

batchSize = 48
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/2021-10-25 1108(MNIST 11DD 16 [0, 1.1] 100 128 ).tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []
eval = None

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 8] Scale:8
W: /device:GPU:0 Fc/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 1350 FC: 26280 Total: 27630
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 8] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.000000
Epoch: 000  Loss: 29.753300 Train: 0.5176 Test: 0.3830 FPS: 4433 
Epoch: 001  Loss: 20.796700 Train: 0.2867 Test: 0.2492 FPS: 5200 S BEST 
Epoch: 002  Loss: 16.726300 Train: 0.1752 Test: 0.1307 FPS: 4389 S BEST 
Epoch: 003  Loss: 13.989900 Train: 0.1233 Test: 0.0976 FPS: 4427 S BEST 
Epoch: 004  Loss: 12.097800 Train: 0.0937 Test: 0.0905 FPS: 4566 S BEST 
Epoch: 005  Loss: 11.003500 Train: 0.0776 Test: 0.0708 FPS: 4516 S BEST 
Epoch: 006  Loss: 10.665900 Train: 0.0752 Test: 0.0624 FPS: 4529 S BEST 
Epoch: 007  Loss: 9.836200 Train: 0.0638 Test: 0.0504 FPS: 4581 S BEST 
Epoch: 008  Loss: 9.463200 Train: 0.0599 Test: 0.0440 FPS: 4771 S BEST 
Epoch: 009  Loss: 9.273400 Train: 0.0565 Test: 0.0480 FPS: 4449 
Epoch: 010  Loss: 9.049600 Train: 0.0530 Test: 0.0469 FPS: 4679 
Epoch: 011  Loss: 8.988000 Train: 0.0525 Test: 0.0442 FPS: 4987 
Epoch: 012  Loss: 8.788200 Train: 0.0493 Test: 0.0491 FPS: 4982 
Epoch: 013  Loss: 8.779700 Train: 0.0499 Test: 0.0415 FPS: 5003 S BEST 
Epoch: 014  Loss: 8.653000 Train: 0.0480 Test: 0.0461 FPS: 4782 
Epoch: 015  Loss: 8.653300 Train: 0.0479 Test: 0.0427 FPS: 4849 
Epoch: 016  Loss: 8.533400 Train: 0.0471 Test: 0.0430 FPS: 4803 
Epoch: 017  Loss: 8.430400 Train: 0.0473 Test: 0.0826 FPS: 4972 
Epoch: 018  Loss: 8.397200 Train: 0.0462 Test: 0.0496 FPS: 4945 
Epoch: 019  Loss: 8.359200 Train: 0.0452 Test: 0.0375 FPS: 4641 S BEST 
Epoch: 020  Loss: 8.245400 Train: 0.0431 Test: 0.0473 FPS: 4632 
Epoch: 021  Loss: 8.184000 Train: 0.0425 Test: 0.0370 FPS: 4949 S BEST 
Epoch: 022  Loss: 8.217100 Train: 0.0420 Test: 0.0406 FPS: 4665 
Epoch: 023  Loss: 8.129300 Train: 0.0399 Test: 0.0390 FPS: 5015 
Epoch: 024  Loss: 8.106500 Train: 0.0403 Test: 0.0394 FPS: 4909 
Epoch: 025  Loss: 8.153800 Train: 0.0405 Test: 0.0404 FPS: 5023 
Epoch: 026  Loss: 8.175500 Train: 0.0427 Test: 0.0386 FPS: 5034 
Epoch: 027  Loss: 8.080400 Train: 0.0402 Test: 0.0358 FPS: 4923 S BEST 
Epoch: 028  Loss: 8.054100 Train: 0.0395 Test: 0.0355 FPS: 4702 S BEST 
Epoch: 029  Loss: 8.105100 Train: 0.0404 Test: 0.0338 FPS: 4750 S BEST 
Epoch: 030  Loss: 8.070400 Train: 0.0392 Test: 0.0351 FPS: 4777 
Epoch: 031  Loss: nan Train: 0.3205 Test: 1.0000 FPS: 4972 
