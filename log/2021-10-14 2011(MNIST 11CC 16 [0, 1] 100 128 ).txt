2021-10-14 20:11:20 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 12  # bit width of gradients
bitsE = 12 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.000000
Epoch: 000  Loss: 675.472222 Train: 0.6303 Test: 0.6270 FPS: 7038 
Epoch: 001  Loss: 676.549145 Train: 0.6311 Test: 0.6270 FPS: 11748 S BEST 
Epoch: 002  Loss: 676.069444 Train: 0.6308 Test: 0.6270 FPS: 10526 
Epoch: 003  Loss: 675.652778 Train: 0.6307 Test: 0.6234 FPS: 10831 S BEST 
Epoch: 004  Loss: 668.280983 Train: 0.6255 Test: 0.6395 FPS: 10896 
Epoch: 005  Loss: 648.949786 Train: 0.5894 Test: 0.6081 FPS: 10964 S BEST 
Epoch: 006  Loss: 650.540598 Train: 0.6266 Test: 0.6450 FPS: 10867 
Epoch: 007  Loss: 624.110043 Train: 0.5825 Test: 0.5718 FPS: 10816 S BEST 
Epoch: 008  Loss: 611.414530 Train: 0.5456 Test: 0.5489 FPS: 10901 S BEST 
Epoch: 009  Loss: 599.567308 Train: 0.5108 Test: 0.5036 FPS: 10630 S BEST 
Epoch: 010  Loss: 594.649573 Train: 0.4880 Test: 0.4845 FPS: 10853 S BEST 
Epoch: 011  Loss: 590.074786 Train: 0.4707 Test: 0.4510 FPS: 10903 S BEST 
Epoch: 012  Loss: 586.753205 Train: 0.4835 Test: 0.4487 FPS: 10823 S BEST 
Epoch: 013  Loss: 580.572650 Train: 0.4809 Test: 0.5045 FPS: 10710 
Epoch: 014  Loss: 588.219017 Train: 0.4975 Test: 0.5218 FPS: 10606 
Epoch: 015  Loss: 600.263889 Train: 0.5612 Test: 0.5184 FPS: 11142 
Epoch: 016  Loss: 583.932692 Train: 0.5160 Test: 0.5011 FPS: 10961 
Epoch: 017  Loss: 563.943376 Train: 0.4581 Test: 0.4077 FPS: 11593 S BEST 
Epoch: 018  Loss: 557.436966 Train: 0.4747 Test: 0.5605 FPS: 10210 
Epoch: 019  Loss: 554.668803 Train: 0.5458 Test: 0.6696 FPS: 11010 
Epoch: 020  Loss: 527.605769 Train: 0.6133 Test: 0.6088 FPS: 11450 
Epoch: 021  Loss: 491.507479 Train: 0.5892 Test: 0.6081 FPS: 11300 
Epoch: 022  Loss: 486.223291 Train: 0.5745 Test: 0.5959 FPS: 11431 
Epoch: 023  Loss: 469.622863 Train: 0.6504 Test: 0.7104 FPS: 11055 
Epoch: 024  Loss: 496.548077 Train: 0.6602 Test: 0.6576 FPS: 11124 
Epoch: 025  Loss: 557.882479 Train: 0.6581 Test: 0.6613 FPS: 11316 
Epoch: 026  Loss: 535.987179 Train: 0.6352 Test: 0.5940 FPS: 11553 
Epoch: 027  Loss: 454.662393 Train: 0.5745 Test: 0.5745 FPS: 11635 
Epoch: 028  Loss: 418.378205 Train: 0.5859 Test: 0.6806 FPS: 11640 
Epoch: 029  Loss: 415.798077 Train: 0.5719 Test: 0.2566 FPS: 11624 S BEST 
Epoch: 030  Loss: 334.526709 Train: 0.5700 Test: 0.6697 FPS: 10502 
Epoch: 031  Loss: 351.440171 Train: 0.5782 Test: 0.5065 FPS: 10208 
Epoch: 032  Loss: 433.719017 Train: 0.5282 Test: 0.5369 FPS: 10881 
Epoch: 033  Loss: 410.445513 Train: 0.5768 Test: 0.7202 FPS: 11374 
Epoch: 034  Loss: 310.178419 Train: 0.6416 Test: 0.6960 FPS: 11363 
Epoch: 035  Loss: 272.831197 Train: 0.5444 Test: 0.7203 FPS: 11223 
Epoch: 036  Loss: 339.988248 Train: 0.5207 Test: 0.4650 FPS: 10746 
Epoch: 037  Loss: 386.777778 Train: 0.4585 Test: 0.3360 FPS: 9968 
Epoch: 038  Loss: 194.664530 Train: 0.1464 Test: 0.0727 FPS: 11455 S BEST 
Epoch: 039  Loss: 124.303419 Train: 0.0527 Test: 0.0348 FPS: 9683 S BEST 
Epoch: 040  Loss: nan Train: 0.6727 Test: 1.0000 FPS: 11002 
Epoch: 041  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10741 
Epoch: 042  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10662 
Epoch: 043  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11204 
Epoch: 044  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11326 
Epoch: 045  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11221 
Epoch: 046  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11021 
Epoch: 047  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11484 
Epoch: 048  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11285 
Epoch: 049  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11477 
Epoch: 050  