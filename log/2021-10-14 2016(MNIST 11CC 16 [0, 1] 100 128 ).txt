2021-10-14 20:16:13 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 12  # bit width of gradients
bitsE = 12 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.000000
Epoch: 000  Loss: 611.675214 Train: 0.3600 Test: 0.3565 FPS: 7337 
Epoch: 001  Loss: 612.621795 Train: 0.3606 Test: 0.3565 FPS: 11494 S BEST 
Epoch: 002  Loss: 611.243590 Train: 0.3558 Test: 0.3565 FPS: 10455 
Epoch: 003  Loss: 612.153846 Train: 0.3604 Test: 0.3565 FPS: 10824 
Epoch: 004  Loss: 606.816239 Train: 0.3636 Test: 0.3781 FPS: 11110 
Epoch: 005  Loss: 591.822650 Train: 0.3949 Test: 0.4291 FPS: 11107 
Epoch: 006  Loss: 584.384615 Train: 0.4318 Test: 0.4468 FPS: 10354 
Epoch: 007  Loss: 585.036325 Train: 0.4893 Test: 0.5182 FPS: 10329 
Epoch: 008  Loss: 572.978632 Train: 0.4767 Test: 0.4671 FPS: 10743 
Epoch: 009  Loss: 563.064103 Train: 0.4870 Test: 0.5423 FPS: 10834 
Epoch: 010  Loss: 571.690171 Train: 0.5347 Test: 0.5273 FPS: 10915 
Epoch: 011  Loss: 573.213675 Train: 0.5614 Test: 0.4761 FPS: 11571 
Epoch: 012  Loss: 557.506410 Train: 0.5004 Test: 0.4324 FPS: 11768 
Epoch: 013  Loss: 534.038462 Train: 0.4424 Test: 0.4304 FPS: 11784 
Epoch: 014  Loss: 524.351496 Train: 0.4532 Test: 0.4916 FPS: 11443 
Epoch: 015  Loss: 534.405983 Train: 0.5095 Test: 0.5260 FPS: 11395 
Epoch: 016  Loss: 537.455128 Train: 0.5082 Test: 0.5233 FPS: 11718 
Epoch: 017  Loss: 525.422009 Train: 0.5367 Test: 0.5783 FPS: 11737 
Epoch: 018  Loss: 526.549145 Train: 0.5334 Test: 0.4849 FPS: 11530 
Epoch: 019  Loss: 546.753205 Train: 0.5734 Test: 0.5921 FPS: 11571 
Epoch: 020  Loss: 544.804487 Train: 0.6078 Test: 0.5541 FPS: 11807 
Epoch: 021  Loss: 546.420940 Train: 0.5997 Test: 0.6057 FPS: 11778 
Epoch: 022  Loss: 540.016026 Train: 0.5864 Test: 0.5557 FPS: 11756 
Epoch: 023  Loss: 522.166667 Train: 0.5688 Test: 0.5314 FPS: 11640 
Epoch: 024  Loss: 521.899573 Train: 0.5698 Test: 0.6151 FPS: 11781 
Epoch: 025  Loss: 521.107906 Train: 0.6033 Test: 0.5060 FPS: 11697 
Epoch: 026  Loss: 520.020299 Train: 0.5958 Test: 0.6594 FPS: 11735 
Epoch: 027  Loss: 514.080128 Train: 0.6026 Test: 0.6182 FPS: 11424 
Epoch: 028  Loss: 499.215812 Train: 0.5810 Test: 0.5384 FPS: 11482 
Epoch: 029  Loss: 484.363248 Train: 0.5803 Test: 0.5652 FPS: 11607 
Epoch: 030  Loss: 487.739316 Train: 0.5905 Test: 0.6236 FPS: 10911 
Epoch: 031  Loss: 509.542735 Train: 0.5497 Test: 0.5102 FPS: 11428 
Epoch: 032  Loss: 502.216880 Train: 0.5422 Test: 0.5393 FPS: 11570 
Epoch: 033  Loss: 511.610043 Train: 0.5629 Test: 0.6184 FPS: 11580 
Epoch: 034  Loss: 536.551282 Train: 0.5729 Test: 0.5350 FPS: 11749 
Epoch: 035  Loss: 541.143162 Train: 0.5884 Test: 0.5750 FPS: 11358 
Epoch: 036  Loss: 516.368590 Train: 0.6100 Test: 0.6378 FPS: 11748 
Epoch: 037  Loss: 478.969017 Train: 0.6260 Test: 0.6183 FPS: 11744 
Epoch: 038  Loss: 438.725427 Train: 0.5654 Test: 0.6490 FPS: 11609 
Epoch: 039  Loss: 354.360043 Train: 0.4524 Test: 0.2705 FPS: 11264 S BEST 
Epoch: 040  Loss: 239.539530 Train: 0.1838 Test: 0.1518 FPS: 10714 S BEST 
Epoch: 041  Loss: 192.992521 Train: 0.1291 Test: 0.0961 FPS: 10950 S BEST 
Epoch: 042  Loss: 141.000000 Train: 0.0772 Test: 0.0691 FPS: 10831 S BEST 
Epoch: 043  Loss: 114.636752 Train: 0.0494 Test: 0.0392 FPS: 10882 S BEST 
Epoch: 044  Loss: nan Train: 0.5234 Test: 1.0000 FPS: 10972 
Epoch: 045  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11250 
Epoch: 046  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11602 
Epoch: 047  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11719 
Epoch: 048  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11691 
Epoch: 049  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11518 
Epoch: 050  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11737 
Epoch: 051  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11429 
Epoch: 052  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11661 
Epoch: 053  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11712 
Epoch: 054  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11813 
Epoch: 055  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11792 
Epoch: 056  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11832 
Epoch: 057  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11808 
Epoch: 058  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11662 
Epoch: 059  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11738 
Epoch: 060  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11790 
Epoch: 061  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11777 
Epoch: 062  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11723 
Epoch: 063  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11278 
Epoch: 064  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11086 
Epoch: 065  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11324 
Epoch: 066  