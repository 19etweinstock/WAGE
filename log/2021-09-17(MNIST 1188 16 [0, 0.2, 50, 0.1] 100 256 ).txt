2021-09-17 14:29:54 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 8  # bit width of gradients
bitsE = 8 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,0.2, 50, 0.1]

Epoch = 100

batchSize = 256
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc/fc1/ [512, 10] Scale:16
CONV: 52000 FC: 529408 Total: 581408
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc_1/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc_1/fc1/ [512, 10] Scale:16

Optimization Start!

lr: 0.000000 -> 0.200000
Epoch: 000  Loss: 1426.564103 Train: 0.6195 Test: 0.6219 FPS: 9386 
Epoch: 001  Loss: 1427.467949 Train: 0.6197 Test: 0.6219 FPS: 16846 
Epoch: 002  Loss: 1415.732906 Train: 0.6122 Test: 0.5857 FPS: 17091 S BEST 
Epoch: 003  Loss: 1326.380342 Train: 0.4888 Test: 0.4527 FPS: 16000 S BEST 
Epoch: 004  Loss: 1315.925214 Train: 0.5009 Test: 0.5162 FPS: 15251 
Epoch: 005  Loss: 1317.525641 Train: 0.5095 Test: 0.5018 FPS: 15751 
Epoch: 006  Loss: 1316.211538 Train: 0.5101 Test: 0.5586 FPS: 16281 
Epoch: 007  Loss: 1323.871795 Train: 0.5279 Test: 0.4950 FPS: 16557 
Epoch: 008  Loss: 1285.382479 Train: 0.4421 Test: 0.4127 FPS: 16473 S BEST 
Epoch: 009  Loss: 1261.724359 Train: 0.3923 Test: 0.4133 FPS: 16573 
Epoch: 010  Loss: 1280.200855 Train: 0.4444 Test: 0.4391 FPS: 16838 
Epoch: 011  Loss: 1277.540598 Train: 0.4509 Test: 0.4833 FPS: 16592 
Epoch: 012  Loss: 1266.651709 Train: 0.4453 Test: 0.4475 FPS: 16332 
Epoch: 013  Loss: 1255.955128 Train: 0.4256 Test: 0.4304 FPS: 16704 
Epoch: 014  Loss: 1257.982906 Train: 0.4302 Test: 0.4507 FPS: 16791 
Epoch: 015  Loss: 1257.480769 Train: 0.4313 Test: 0.4522 FPS: 16744 
Epoch: 016  Loss: 1240.476496 Train: 0.4242 Test: 0.4044 FPS: 16730 S BEST 
Epoch: 017  Loss: 1249.198718 Train: 0.4672 Test: 0.5351 FPS: 16505 
Epoch: 018  Loss: 1273.358974 Train: 0.5070 Test: 0.4742 FPS: 14993 
Epoch: 019  Loss: 1243.818376 Train: 0.4623 Test: 0.4710 FPS: 16133 
Epoch: 020  Loss: 1221.106838 Train: 0.4380 Test: 0.4239 FPS: 16041 
Epoch: 021  Loss: 1193.408120 Train: 0.4134 Test: 0.4367 FPS: 16170 
Epoch: 022  Loss: 1185.162393 Train: 0.4452 Test: 0.4641 FPS: 16434 
Epoch: 023  Loss: 1169.688034 Train: 0.4682 Test: 0.4502 FPS: 16180 
Epoch: 024  Loss: 1167.250000 Train: 0.4666 Test: 0.5196 FPS: 16092 
Epoch: 025  Loss: 1213.196581 Train: 0.4912 Test: 0.4931 FPS: 16514 
Epoch: 026  Loss: 1185.455128 Train: 0.5024 Test: 0.4950 FPS: 16527 
Epoch: 027  Loss: 1143.044872 Train: 0.5030 Test: 0.5494 FPS: 16533 
Epoch: 028  Loss: 1191.452991 Train: 0.5156 Test: 0.5173 FPS: 15953 
Epoch: 029  Loss: 1191.873932 Train: 0.4722 Test: 0.4994 FPS: 16488 
Epoch: 030  Loss: 1160.222222 Train: 0.4528 Test: 0.4152 FPS: 16527 
Epoch: 031  Loss: 1136.192308 Train: 0.4222 Test: 0.4406 FPS: 16193 
Epoch: 032  Loss: 1137.923077 Train: 0.4584 Test: 0.4473 FPS: 16474 
Epoch: 033  Loss: 1135.485043 Train: 0.4076 Test: 0.4095 FPS: 16550 
Epoch: 034  Loss: 1146.480769 Train: 0.4138 Test: 0.4403 FPS: 16560 
Epoch: 035  Loss: 1162.269231 Train: 0.4511 Test: 0.4819 FPS: 16639 
Epoch: 036  Loss: 1122.059829 Train: 0.5144 Test: 0.5811 FPS: 15819 
Epoch: 037  Loss: 1045.707265 Train: 0.5621 Test: 0.6409 FPS: 16150 
Epoch: 038  Loss: 825.299145 Train: 0.5623 Test: 0.6714 FPS: 16336 
Epoch: 039  Loss: 898.933761 Train: 0.3638 Test: 0.7238 FPS: 16533 
Epoch: 040  Loss: 903.149573 Train: 0.7162 Test: 0.6512 FPS: 16379 
Epoch: 041  Loss: 668.792735 Train: 0.6117 Test: 0.0454 FPS: 15770 S BEST 
Epoch: 042  Loss: 543.215812 Train: 0.5345 Test: 0.0535 FPS: 15382 
Epoch: 043  Loss: 575.805556 Train: 0.2434 Test: 0.4341 FPS: 16372 
Epoch: 044  Loss: 841.376068 Train: 0.4139 Test: 0.5085 FPS: 16441 
Epoch: 045  Loss: 673.089744 Train: 0.5339 Test: 0.6986 FPS: 16292 
Epoch: 046  Loss: 590.448718 Train: 0.5881 Test: 0.7214 FPS: 15651 
Epoch: 047  Loss: 887.175214 Train: 0.5172 Test: 0.4087 FPS: 16434 
Epoch: 048  Loss: 985.572650 Train: 0.5095 Test: 0.6785 FPS: 15021 
Epoch: 049  Loss: 680.579060 Train: 0.6545 Test: 0.6899 FPS: 15864 
lr: 0.200000 -> 0.100000
Epoch: 050  Loss: 843.950855 Train: 0.5878 Test: 0.5086 FPS: 15415 
Epoch: 051  Loss: 961.848291 Train: 0.6130 Test: 0.7936 FPS: 15449 
Epoch: 052  Loss: 562.222222 Train: 0.6333 Test: 0.8826 FPS: 14355 
Epoch: 053  Loss: 335.617521 Train: 0.7537 Test: 0.8557 FPS: 15452 
Epoch: 054  Loss: 358.978632 Train: 0.6728 Test: 0.8700 FPS: 15683 
Epoch: 055  Loss: 511.818376 Train: 0.5834 Test: 0.4071 FPS: 16309 
Epoch: 056  Loss: 743.271368 Train: 0.5764 Test: 0.6875 FPS: 16437 
Epoch: 057  Loss: 486.814103 Train: 0.7370 Test: 0.7819 FPS: 16486 
Epoch: 058  Loss: 496.322650 Train: 0.6895 Test: 0.8058 FPS: 15835 
Epoch: 059  Loss: 445.279915 Train: 0.5721 Test: 0.8728 FPS: 16520 
Epoch: 060  Loss: 291.292735 Train: 0.5796 Test: 0.0087 FPS: 15473 S BEST 
Epoch: 061  Loss: 280.891026 Train: 0.5649 Test: 0.9001 FPS: 16006 
Epoch: 062  Loss: 300.717949 Train: 0.7195 Test: 0.8874 FPS: 16242 
Epoch: 063  Loss: 641.634615 Train: 0.5507 Test: 0.4864 FPS: 16233 
Epoch: 064  Loss: 731.008547 Train: 0.6441 Test: 0.0087 FPS: 16314 
Epoch: 065  Loss: 846.091880 Train: 0.6043 Test: 0.6953 FPS: 16138 
Epoch: 066  Loss: 462.905983 Train: 0.7799 Test: 0.8950 FPS: 15583 
Epoch: 067  Loss: 342.579060 Train: 0.8165 Test: 0.8942 FPS: 15862 
Epoch: 068  Loss: 550.527778 Train: 0.7629 Test: 0.8891 FPS: 16143 
Epoch: 069  Loss: 778.220085 Train: 0.6690 Test: 0.5886 FPS: 16025 
Epoch: 070  Loss: 967.320513 Train: 0.6907 Test: 0.8895 FPS: 16102 
Epoch: 071  Loss: 733.318376 Train: 0.8282 Test: 0.6969 FPS: 15736 
Epoch: 072  Loss: 446.247863 Train: 0.5625 Test: 0.0998 FPS: 16123 
Epoch: 073  Loss: 543.384615 Train: 0.5543 Test: 0.8846 FPS: 16388 
Epoch: 074  Loss: 417.301282 Train: 0.8765 Test: 0.7820 FPS: 16270 
Epoch: 075  Loss: 1089.032051 Train: 0.4560 Test: 0.4946 FPS: 16442 
Epoch: 076  Loss: 1085.792735 Train: 0.4016 Test: 0.4123 FPS: 15010 
Epoch: 077  Loss: 1000.416667 Train: 0.4511 Test: 0.5108 FPS: 16312 
Epoch: 078  Loss: 708.910256 Train: 0.5591 Test: 0.7953 FPS: 16058 
Epoch: 079  Loss: 268.324786 Train: 0.7381 Test: 0.8978 FPS: 16273 
Epoch: 080  Loss: 262.767094 Train: 0.7279 Test: 0.7966 FPS: 16343 
Epoch: 081  Loss: 291.040598 Train: 0.7350 Test: 0.8012 FPS: 16410 
Epoch: 082  Loss: 351.132479 Train: 0.5710 Test: 0.8947 FPS: 15970 
Epoch: 083  Loss: 234.162393 Train: 0.6390 Test: 0.7969 FPS: 15910 
Epoch: 084  Loss: 791.059829 Train: 0.4449 Test: 0.3067 FPS: 14823 
Epoch: 085  Loss: 277.638889 Train: 0.2079 Test: 0.8963 FPS: 15449 
Epoch: 086  Loss: 340.076923 Train: 0.4600 Test: 0.8970 FPS: 13614 
Epoch: 087  Loss: 246.506410 Train: 0.7085 Test: 0.9002 FPS: 13914 
Epoch: 088  Loss: 225.220085 Train: 0.6066 Test: 0.8947 FPS: 12484 
Epoch: 089  Loss: 688.493590 Train: 0.4678 Test: 0.0042 FPS: 15334 S BEST 
Epoch: 090  Loss: nan Train: 0.4231 Test: 1.0000 FPS: 15770 
Epoch: 091  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 16427 
Epoch: 092  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 16500 
Epoch: 093  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 16337 
Epoch: 094  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 15275 
Epoch: 095  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 14719 
Epoch: 096  