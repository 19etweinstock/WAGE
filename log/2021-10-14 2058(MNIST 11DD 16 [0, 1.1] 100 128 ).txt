2021-10-14 20:58:46 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 693.549145 Train: 0.6343 Test: 0.6340 FPS: 8126 
Epoch: 001  Loss: 693.136752 Train: 0.6325 Test: 0.6340 FPS: 12364 
Epoch: 002  Loss: 693.519231 Train: 0.6343 Test: 0.6340 FPS: 11788 
Epoch: 003  Loss: 693.016026 Train: 0.6320 Test: 0.6340 FPS: 10740 
Epoch: 004  Loss: 693.401709 Train: 0.6333 Test: 0.6340 FPS: 11570 
Epoch: 005  Loss: 692.443376 Train: 0.6309 Test: 0.6340 FPS: 11775 
Epoch: 006  Loss: 693.245726 Train: 0.6324 Test: 0.6342 FPS: 11609 
Epoch: 007  Loss: 694.007479 Train: 0.6355 Test: 0.6342 FPS: 11835 
Epoch: 008  Loss: 674.208333 Train: 0.6213 Test: 0.5693 FPS: 12008 S BEST 
Epoch: 009  Loss: 650.029915 Train: 0.5874 Test: 0.5716 FPS: 10659 
Epoch: 010  Loss: 638.896368 Train: 0.5711 Test: 0.5820 FPS: 10331 
Epoch: 011  Loss: 646.746795 Train: 0.6213 Test: 0.5916 FPS: 11398 
Epoch: 012  Loss: 646.942308 Train: 0.6207 Test: 0.6473 FPS: 11923 
Epoch: 013  Loss: 651.752137 Train: 0.6369 Test: 0.6217 FPS: 11754 
Epoch: 014  Loss: 651.037393 Train: 0.6356 Test: 0.6527 FPS: 11753 
Epoch: 015  Loss: 649.216880 Train: 0.6239 Test: 0.6220 FPS: 10688 
Epoch: 016  Loss: 648.805556 Train: 0.6234 Test: 0.6171 FPS: 10956 
Epoch: 017  Loss: 644.221154 Train: 0.6150 Test: 0.5454 FPS: 11245 S BEST 
Epoch: 018  Loss: 621.842949 Train: 0.5662 Test: 0.5565 FPS: 10700 
Epoch: 019  Loss: 623.058761 Train: 0.5767 Test: 0.6086 FPS: 10535 
Epoch: 020  Loss: 629.400641 Train: 0.5902 Test: 0.6193 FPS: 11337 
Epoch: 021  Loss: 620.585470 Train: 0.5600 Test: 0.4933 FPS: 11114 S BEST 
Epoch: 022  Loss: 596.619658 Train: 0.4961 Test: 0.5270 FPS: 11046 
Epoch: 023  Loss: 606.425214 Train: 0.5456 Test: 0.5509 FPS: 11018 
Epoch: 024  Loss: 601.898504 Train: 0.5564 Test: 0.5216 FPS: 11708 
Epoch: 025  Loss: 593.349359 Train: 0.5430 Test: 0.5456 FPS: 11633 
Epoch: 026  Loss: 589.745726 Train: 0.5594 Test: 0.5424 FPS: 11553 
Epoch: 027  Loss: 569.837607 Train: 0.4879 Test: 0.4644 FPS: 11603 S BEST 
Epoch: 028  Loss: 558.025641 Train: 0.4497 Test: 0.4183 FPS: 10688 S BEST 
Epoch: 029  Loss: 547.958333 Train: 0.4180 Test: 0.3890 FPS: 10585 S BEST 
Epoch: 030  Loss: 544.044872 Train: 0.4176 Test: 0.4801 FPS: 10676 
Epoch: 031  Loss: 543.019231 Train: 0.4452 Test: 0.4630 FPS: 11626 
Epoch: 032  Loss: 545.407051 Train: 0.4809 Test: 0.4999 FPS: 11751 
Epoch: 033  Loss: 546.776709 Train: 0.5252 Test: 0.5428 FPS: 11683 
Epoch: 034  Loss: 532.816239 Train: 0.5160 Test: 0.5686 FPS: 11648 
Epoch: 035  Loss: 512.981838 Train: 0.5544 Test: 0.5745 FPS: 11285 
Epoch: 036  Loss: 501.813034 Train: 0.5963 Test: 0.5954 FPS: 11338 
Epoch: 037  Loss: 478.513889 Train: 0.5943 Test: 0.6667 FPS: 11167 
Epoch: 038  Loss: 463.146368 Train: 0.6192 Test: 0.6619 FPS: 11466 
Epoch: 039  Loss: 397.544872 Train: 0.6213 Test: 0.6451 FPS: 11660 
Epoch: 040  Loss: 347.474359 Train: 0.6960 Test: 0.4268 FPS: 11597 
Epoch: 041  Loss: 429.525641 Train: 0.5410 Test: 0.4834 FPS: 11141 
Epoch: 042  Loss: 440.644231 Train: 0.5173 Test: 0.6041 FPS: 11281 
Epoch: 043  Loss: 437.068376 Train: 0.5880 Test: 0.5968 FPS: 11688 
Epoch: 044  Loss: 433.542735 Train: 0.6159 Test: 0.6024 FPS: 11130 
Epoch: 045  Loss: 449.342949 Train: 0.6521 Test: 0.7060 FPS: 11559 
Epoch: 046  Loss: 446.548077 Train: 0.6727 Test: 0.6686 FPS: 11514 
Epoch: 047  Loss: 514.759615 Train: 0.5541 Test: 0.4894 FPS: 11599 
Epoch: 048  Loss: 513.969017 Train: 0.5698 Test: 0.6451 FPS: 11575 
Epoch: 049  Loss: 515.990385 Train: 0.5943 Test: 0.6203 FPS: 11131 
Epoch: 050  Loss: 505.269231 Train: 0.5567 Test: 0.4367 FPS: 10124 
Epoch: 051  Loss: 458.128205 Train: 0.4483 Test: 0.5121 FPS: 10433 
Epoch: 052  Loss: 445.774573 Train: 0.5030 Test: 0.5120 FPS: 10972 
Epoch: 053  Loss: 446.410256 Train: 0.5024 Test: 0.4789 FPS: 10941 
Epoch: 054  Loss: 454.417735 Train: 0.4676 Test: 0.4940 FPS: 10474 
Epoch: 055  Loss: 485.388889 Train: 0.4721 Test: 0.5298 FPS: 11616 
Epoch: 056  Loss: 477.233974 Train: 0.5433 Test: 0.5840 FPS: 11545 
Epoch: 057  Loss: 495.483974 Train: 0.5878 Test: 0.5783 FPS: 11771 
Epoch: 058  Loss: 485.108974 Train: 0.6042 Test: 0.5485 FPS: 11630 
Epoch: 059  Loss: 472.584402 Train: 0.6101 Test: 0.6679 FPS: 10190 
Epoch: 060  Loss: 453.804487 Train: 0.6516 Test: 0.5598 FPS: 10356 
Epoch: 061  Loss: 477.043803 Train: 0.6232 Test: 0.5703 FPS: 9631 
Epoch: 062  Loss: 477.405983 Train: 0.6008 Test: 0.5639 FPS: 8594 
Epoch: 063  Loss: 481.246795 Train: 0.5942 Test: 0.6390 FPS: 11186 
Epoch: 064  Loss: 399.037393 Train: 0.4414 Test: 0.2567 FPS: 11387 S BEST 
Epoch: 065  Loss: 309.514957 Train: 0.2273 Test: 0.1749 FPS: 10366 S BEST 
Epoch: 066  Loss: 170.588675 Train: 0.1035 Test: 0.1012 FPS: 10143 S BEST 
Epoch: 067  Loss: 164.121795 Train: 0.1015 Test: 0.0988 FPS: 10483 S BEST 
Epoch: 068  Loss: 187.895299 Train: 0.1278 Test: 0.0959 FPS: 10916 S BEST 
Epoch: 069  Loss: 170.754274 Train: 0.1014 Test: 0.1207 FPS: 10950 
Epoch: 070  Loss: 185.818376 Train: 0.1164 Test: 0.0858 FPS: 11204 S BEST 
Epoch: 071  Loss: 176.201923 Train: 0.1039 Test: 0.1030 FPS: 11040 
Epoch: 072  Loss: 170.804487 Train: 0.0913 Test: 0.0884 FPS: 11078 
Epoch: 073  Loss: 162.970085 Train: 0.0734 Test: 0.0755 FPS: 11727 S BEST 
Epoch: 074  Loss: 156.323718 Train: 0.0710 Test: 0.0665 FPS: 11040 S BEST 
Epoch: 075  Loss: 133.574786 Train: 0.0554 Test: 0.0185 FPS: 11307 S BEST 
Epoch: 076  Loss: nan Train: 0.8806 Test: 1.0000 FPS: 11008 
Epoch: 077  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10616 
Epoch: 078  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11769 
Epoch: 079  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11658 
Epoch: 080  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11607 
Epoch: 081  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11730 
Epoch: 082  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11684 
Epoch: 083  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11423 
Epoch: 084  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11647 
Epoch: 085  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10784 
Epoch: 086  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11584 
Epoch: 087  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11642 
Epoch: 088  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11610 
Epoch: 089  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11239 
Epoch: 090  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11697 
Epoch: 091  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11545 
Epoch: 092  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11128 
Epoch: 093  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10367 
Epoch: 094  