2021-09-17 15:43:50 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 12  # bit width of gradients
bitsE = 12 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc/fc1/ [512, 10] Scale:16
CONV: 52000 FC: 529408 Total: 581408
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc_1/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc_1/fc1/ [512, 10] Scale:16

Optimization Start!

lr: 0.000000 -> 1.000000
Epoch: 000  Loss: 677.388889 Train: 0.4608 Test: 0.4623 FPS: 6859 
Epoch: 001  Loss: 677.824786 Train: 0.4606 Test: 0.4623 FPS: 11202 
Epoch: 002  Loss: 678.521368 Train: 0.4644 Test: 0.4623 FPS: 10436 
Epoch: 003  Loss: 677.295940 Train: 0.4594 Test: 0.4623 FPS: 10160 
Epoch: 004  Loss: 672.352564 Train: 0.4480 Test: 0.4218 FPS: 11297 S BEST 
Epoch: 005  Loss: 634.571581 Train: 0.3437 Test: 0.3461 FPS: 11135 S BEST 
Epoch: 006  Loss: 630.622863 Train: 0.3461 Test: 0.3469 FPS: 11230 
Epoch: 007  Loss: 633.943376 Train: 0.3772 Test: 0.3760 FPS: 11430 
Epoch: 008  Loss: 637.214744 Train: 0.3876 Test: 0.4120 FPS: 11272 
Epoch: 009  Loss: 636.366453 Train: 0.3880 Test: 0.3457 FPS: 11241 S BEST 
Epoch: 010  Loss: 632.970085 Train: 0.3789 Test: 0.4120 FPS: 10384 
Epoch: 011  Loss: 637.917735 Train: 0.4133 Test: 0.4084 FPS: 11282 
Epoch: 012  Loss: 634.788462 Train: 0.4020 Test: 0.3860 FPS: 11261 
Epoch: 013  Loss: 630.711538 Train: 0.3862 Test: 0.3823 FPS: 11266 
Epoch: 014  Loss: 627.505342 Train: 0.3771 Test: 0.3809 FPS: 10371 
Epoch: 015  Loss: 629.725427 Train: 0.3870 Test: 0.3813 FPS: 10852 
Epoch: 016  Loss: 624.260684 Train: 0.3712 Test: 0.3448 FPS: 10391 S BEST 
Epoch: 017  Loss: 621.483974 Train: 0.3629 Test: 0.3627 FPS: 9972 
Epoch: 018  Loss: 612.821581 Train: 0.3346 Test: 0.3113 FPS: 10107 S BEST 
Epoch: 019  Loss: 613.057692 Train: 0.3337 Test: 0.3584 FPS: 10179 
Epoch: 020  Loss: 621.336538 Train: 0.3785 Test: 0.4039 FPS: 10551 
Epoch: 021  Loss: 632.284188 Train: 0.4237 Test: 0.4130 FPS: 10593 
Epoch: 022  Loss: 630.818376 Train: 0.4320 Test: 0.4427 FPS: 10618 
Epoch: 023  Loss: 631.110043 Train: 0.4384 Test: 0.4357 FPS: 10748 
Epoch: 024  Loss: 621.898504 Train: 0.4122 Test: 0.3853 FPS: 10670 
Epoch: 025  Loss: 609.387821 Train: 0.3799 Test: 0.3778 FPS: 10756 
Epoch: 026  Loss: 604.600427 Train: 0.3811 Test: 0.3712 FPS: 10678 
Epoch: 027  Loss: 596.866453 Train: 0.3777 Test: 0.3814 FPS: 10993 
Epoch: 028  Loss: 595.685897 Train: 0.3963 Test: 0.4091 FPS: 11026 
Epoch: 029  Loss: 592.460470 Train: 0.4057 Test: 0.4262 FPS: 11144 
Epoch: 030  Loss: 584.214744 Train: 0.3948 Test: 0.3708 FPS: 10987 
Epoch: 031  Loss: 575.268162 Train: 0.3803 Test: 0.4380 FPS: 10840 
Epoch: 032  Loss: 597.435897 Train: 0.4634 Test: 0.5024 FPS: 10615 
Epoch: 033  Loss: 600.481838 Train: 0.4615 Test: 0.4293 FPS: 9744 
Epoch: 034  Loss: 589.040598 Train: 0.4238 Test: 0.3877 FPS: 10350 
Epoch: 035  Loss: 583.345085 Train: 0.4017 Test: 0.4114 FPS: 11055 
Epoch: 036  Loss: 583.099359 Train: 0.4460 Test: 0.4146 FPS: 10789 
Epoch: 037  Loss: 570.732906 Train: 0.4392 Test: 0.4935 FPS: 9800 
Epoch: 038  Loss: 576.415598 Train: 0.4908 Test: 0.4691 FPS: 10526 
Epoch: 039  Loss: 568.205128 Train: 0.4956 Test: 0.5221 FPS: 10546 
Epoch: 040  Loss: 573.967949 Train: 0.4559 Test: 0.4265 FPS: 10414 
Epoch: 041  Loss: 575.314103 Train: 0.4414 Test: 0.4183 FPS: 7798 
Epoch: 042  Loss: 577.866453 Train: 0.4918 Test: 0.4455 FPS: 10488 
Epoch: 043  Loss: 589.498932 Train: 0.4919 Test: 0.5655 FPS: 9465 
Epoch: 044  Loss: 605.628205 Train: 0.5489 Test: 0.5571 FPS: 9328 
Epoch: 045  Loss: 590.683761 Train: 0.5000 Test: 0.4718 FPS: 9599 
Epoch: 046  Loss: 580.402778 Train: 0.4581 Test: 0.4708 FPS: 9736 
Epoch: 047  Loss: 581.700855 Train: 0.5081 Test: 0.4889 FPS: 10233 
Epoch: 048  Loss: 576.264957 Train: 0.5108 Test: 0.4516 FPS: 10109 
Epoch: 049  Loss: 582.122863 Train: 0.4985 Test: 0.4329 FPS: 10230 
Epoch: 050  Loss: 570.052350 Train: 0.4759 Test: 0.4858 FPS: 10470 
Epoch: 051  Loss: 567.480769 Train: 0.4837 Test: 0.5250 FPS: 10835 
Epoch: 052  Loss: 564.518162 Train: 0.5516 Test: 0.5427 FPS: 10777 
Epoch: 053  Loss: 540.440171 Train: 0.4706 Test: 0.4623 FPS: 10265 
Epoch: 054  Loss: 543.884615 Train: 0.4888 Test: 0.5259 FPS: 10245 
Epoch: 055  Loss: 553.102564 Train: 0.5413 Test: 0.4890 FPS: 10299 
Epoch: 056  Loss: 582.157051 Train: 0.4976 Test: 0.4371 FPS: 10870 
Epoch: 057  Loss: 583.033120 Train: 0.4618 Test: 0.4863 FPS: 10481 
Epoch: 058  Loss: 584.864316 Train: 0.4690 Test: 0.4554 FPS: 10990 
Epoch: 059  Loss: 587.415598 Train: 0.4401 Test: 0.4432 FPS: 10881 
Epoch: 060  Loss: 593.175214 Train: 0.4092 Test: 0.4108 FPS: 10416 
Epoch: 061  Loss: 603.410256 Train: 0.4404 Test: 0.4872 FPS: 10672 
Epoch: 062  Loss: 616.991453 Train: 0.5043 Test: 0.4894 FPS: 10422 
Epoch: 063  Loss: 610.897436 Train: 0.4871 Test: 0.4728 FPS: 10761 
Epoch: 064  Loss: 616.525641 Train: 0.4826 Test: 0.4560 FPS: 9942 
Epoch: 065  Loss: 615.392094 Train: 0.4647 Test: 0.4385 FPS: 9348 
Epoch: 066  Loss: 606.956197 Train: 0.4419 Test: 0.4194 FPS: 10831 
Epoch: 067  Loss: 595.462607 Train: 0.4022 Test: 0.3699 FPS: 10473 
Epoch: 068  Loss: 617.579060 Train: 0.4456 Test: 0.5117 FPS: 10651 
Epoch: 069  Loss: 615.454060 Train: 0.4951 Test: 0.4938 FPS: 10994 
Epoch: 070  Loss: 599.476496 Train: 0.4655 Test: 0.4679 FPS: 10564 
Epoch: 071  Loss: 589.557692 Train: 0.4901 Test: 0.5234 FPS: 10909 
Epoch: 072  Loss: 587.105769 Train: 0.5130 Test: 0.4904 FPS: 11000 
Epoch: 073  Loss: 580.442308 Train: 0.4849 Test: 0.4720 FPS: 10757 
Epoch: 074  Loss: 619.791667 Train: 0.4872 Test: 0.4832 FPS: 10464 
Epoch: 075  Loss: 602.714744 Train: 0.4702 Test: 0.5114 FPS: 10985 
Epoch: 076  Loss: 590.445513 Train: 0.4973 Test: 0.4949 FPS: 10707 
Epoch: 077  Loss: 570.301282 Train: 0.5548 Test: 0.5461 FPS: 10252 
Epoch: 078  Loss: 533.447650 Train: 0.5216 Test: 0.6207 FPS: 10629 
Epoch: 079  Loss: 519.563034 Train: 0.5464 Test: 0.5006 FPS: 10865 
Epoch: 080  Loss: 458.085470 Train: 0.5051 Test: 0.5572 FPS: 10916 
Epoch: 081  Loss: 472.954060 Train: 0.4844 Test: 0.6127 FPS: 9967 
Epoch: 082  Loss: 478.683761 Train: 0.5702 Test: 0.6444 FPS: 10671 
Epoch: 083  Loss: 499.922009 Train: 0.5419 Test: 0.5617 FPS: 10838 
Epoch: 084  Loss: 411.797009 Train: 0.6252 Test: 0.3612 FPS: 11048 
Epoch: 085  Loss: 437.983974 Train: 0.6370 Test: 0.6843 FPS: 10755 
Epoch: 086  Loss: 417.944444 Train: 0.6143 Test: 0.5145 FPS: 10825 
Epoch: 087  Loss: 469.278846 Train: 0.5904 Test: 0.6430 FPS: 10934 
Epoch: 088  Loss: 440.059829 Train: 0.6646 Test: 0.3334 FPS: 10956 
Epoch: 089  Loss: 554.316239 Train: 0.6907 Test: 0.4711 FPS: 10455 
Epoch: 090  Loss: 475.270299 Train: 0.3442 Test: 0.2374 FPS: 10690 S BEST 
Epoch: 091  Loss: 321.868590 Train: 0.2212 Test: 0.1802 FPS: 9643 S BEST 
Epoch: 092  Loss: 242.049145 Train: 0.1689 Test: 0.1222 FPS: 8942 S BEST 
Epoch: 093  Loss: 208.308761 Train: 0.1587 Test: 0.0924 FPS: 10447 S BEST 
Epoch: 094  Loss: 183.772436 Train: 0.1537 Test: 0.0550 FPS: 9405 S BEST 
Epoch: 095  Loss: 119.940171 Train: 0.0506 Test: 0.0265 FPS: 9659 S BEST 
Epoch: 096  Loss: 102.441239 Train: 0.0239 Test: 0.0200 FPS: 10517 S BEST 
Epoch: 097  Loss: 98.495726 Train: 0.0281 Test: 0.0185 FPS: 10914 S BEST 
Epoch: 098  Loss: 88.409188 Train: 0.0155 Test: 0.0083 FPS: 10902 S BEST 
Epoch: 099  Loss: nan Train: 0.1737 Test: 1.0000 FPS: 10651 
