2021-09-17 15:13:28 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 12  # bit width of gradients
bitsE = 12 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1]

Epoch = 200

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc/fc1/ [512, 10] Scale:16
CONV: 52000 FC: 529408 Total: 581408
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 32] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 32, 64] Scale:32
W: /device:GPU:0 Fc_1/fc0/ [1024, 512] Scale:32
W: /device:GPU:0 Fc_1/fc1/ [512, 10] Scale:16

Optimization Start!

lr: 0.000000 -> 1.000000
Epoch: 000  Loss: 741.901709 Train: 0.7272 Test: 0.7299 FPS: 7478 
Epoch: 001  Loss: 742.992521 Train: 0.7298 Test: 0.7299 FPS: 11473 
Epoch: 002  Loss: 742.182692 Train: 0.7283 Test: 0.7299 FPS: 11228 
Epoch: 003  Loss: 742.559829 Train: 0.7283 Test: 0.7321 FPS: 10873 
Epoch: 004  Loss: 721.782051 Train: 0.6768 Test: 0.6100 FPS: 10914 S BEST 
Epoch: 005  Loss: 689.030983 Train: 0.5918 Test: 0.5736 FPS: 10584 S BEST 
Epoch: 006  Loss: 685.880342 Train: 0.5820 Test: 0.5705 FPS: 10093 S BEST 
Epoch: 007  Loss: 680.494658 Train: 0.5775 Test: 0.5786 FPS: 10349 
Epoch: 008  Loss: 679.268162 Train: 0.5746 Test: 0.5670 FPS: 10742 S BEST 
Epoch: 009  Loss: 678.377137 Train: 0.5700 Test: 0.5483 FPS: 11074 S BEST 
Epoch: 010  Loss: 666.459402 Train: 0.5218 Test: 0.5021 FPS: 10855 S BEST 
Epoch: 011  Loss: 658.604701 Train: 0.4937 Test: 0.4637 FPS: 10833 S BEST 
Epoch: 012  Loss: 653.513889 Train: 0.4741 Test: 0.4695 FPS: 10885 
Epoch: 013  Loss: 653.879274 Train: 0.4740 Test: 0.4635 FPS: 11152 S BEST 
Epoch: 014  Loss: 651.896368 Train: 0.4686 Test: 0.4829 FPS: 10796 
Epoch: 015  Loss: 649.631410 Train: 0.4596 Test: 0.4764 FPS: 11180 
Epoch: 016  Loss: 653.418803 Train: 0.4711 Test: 0.4727 FPS: 11007 
Epoch: 017  Loss: 661.012821 Train: 0.4966 Test: 0.5001 FPS: 10875 
Epoch: 018  Loss: 658.536325 Train: 0.4905 Test: 0.4578 FPS: 10895 S BEST 
Epoch: 019  Loss: 643.679487 Train: 0.4334 Test: 0.4350 FPS: 11030 S BEST 
Epoch: 020  Loss: 639.875000 Train: 0.4241 Test: 0.4161 FPS: 10762 S BEST 
Epoch: 021  Loss: 634.679487 Train: 0.4090 Test: 0.4070 FPS: 10588 S BEST 
Epoch: 022  Loss: 635.153846 Train: 0.4159 Test: 0.4178 FPS: 10815 
Epoch: 023  Loss: 639.801282 Train: 0.4374 Test: 0.4390 FPS: 11096 
Epoch: 024  Loss: 642.092949 Train: 0.4489 Test: 0.4541 FPS: 11074 
Epoch: 025  Loss: 638.355769 Train: 0.4397 Test: 0.4303 FPS: 11013 
Epoch: 026  Loss: 636.957265 Train: 0.4371 Test: 0.4300 FPS: 10790 
Epoch: 027  Loss: 632.996795 Train: 0.4231 Test: 0.4063 FPS: 10963 S BEST 
Epoch: 028  Loss: 630.561966 Train: 0.4227 Test: 0.4274 FPS: 10879 
Epoch: 029  Loss: 631.003205 Train: 0.4373 Test: 0.4571 FPS: 10627 
Epoch: 030  Loss: 628.840812 Train: 0.4407 Test: 0.4377 FPS: 10908 
Epoch: 031  Loss: 634.202991 Train: 0.4685 Test: 0.4814 FPS: 10953 
Epoch: 032  Loss: 636.332265 Train: 0.4820 Test: 0.4671 FPS: 11006 
Epoch: 033  Loss: 640.669872 Train: 0.5066 Test: 0.4849 FPS: 10964 
Epoch: 034  Loss: 638.573718 Train: 0.5012 Test: 0.5051 FPS: 10918 
Epoch: 035  Loss: 641.441239 Train: 0.5067 Test: 0.5079 FPS: 11003 
Epoch: 036  Loss: 631.081197 Train: 0.4716 Test: 0.4456 FPS: 10851 
Epoch: 037  Loss: 629.167735 Train: 0.4740 Test: 0.5010 FPS: 10993 
Epoch: 038  Loss: 625.261752 Train: 0.4901 Test: 0.5165 FPS: 10927 
Epoch: 039  Loss: 619.661325 Train: 0.4933 Test: 0.5135 FPS: 10957 
Epoch: 040  Loss: 622.869658 Train: 0.5330 Test: 0.5488 FPS: 10630 
Epoch: 041  Loss: 621.935897 Train: 0.5172 Test: 0.4764 FPS: 10599 
Epoch: 042  Loss: 611.115385 Train: 0.4613 Test: 0.4199 FPS: 10973 
Epoch: 043  Loss: 593.000000 Train: 0.4439 Test: 0.4421 FPS: 10901 
Epoch: 044  Loss: 588.026709 Train: 0.4301 Test: 0.4478 FPS: 10922 
Epoch: 045  Loss: 585.205128 Train: 0.4169 Test: 0.4693 FPS: 10851 
Epoch: 046  Loss: 595.414530 Train: 0.4836 Test: 0.5051 FPS: 10864 
Epoch: 047  Loss: 575.694444 Train: 0.4490 Test: 0.3957 FPS: 10961 S BEST 
Epoch: 048  Loss: 574.605769 Train: 0.3965 Test: 0.4079 FPS: 10983 
Epoch: 049  Loss: 582.908120 Train: 0.4148 Test: 0.3618 FPS: 10840 S BEST 
Epoch: 050  Loss: 591.090812 Train: 0.3890 Test: 0.4025 FPS: 10187 
Epoch: 051  Loss: 590.426282 Train: 0.4219 Test: 0.4686 FPS: 9683 
Epoch: 052  Loss: 596.700855 Train: 0.4749 Test: 0.4695 FPS: 9560 
Epoch: 053  Loss: 606.189103 Train: 0.5199 Test: 0.5247 FPS: 9498 
Epoch: 054  Loss: 589.074786 Train: 0.4912 Test: 0.4611 FPS: 10338 
Epoch: 055  Loss: 575.348291 Train: 0.4837 Test: 0.5181 FPS: 10281 
Epoch: 056  Loss: 568.975427 Train: 0.5356 Test: 0.5181 FPS: 10970 
Epoch: 057  Loss: 578.161325 Train: 0.4470 Test: 0.4045 FPS: 10347 
Epoch: 058  Loss: 593.214744 Train: 0.4784 Test: 0.4982 FPS: 10515 
Epoch: 059  Loss: 583.956197 Train: 0.4778 Test: 0.4752 FPS: 10798 
Epoch: 060  Loss: 591.780983 Train: 0.4985 Test: 0.4984 FPS: 10899 
Epoch: 061  Loss: 586.694444 Train: 0.5001 Test: 0.4808 FPS: 10730 
Epoch: 062  Loss: 563.941239 Train: 0.4780 Test: 0.4853 FPS: 11106 
Epoch: 063  Loss: 558.698718 Train: 0.5252 Test: 0.5811 FPS: 11020 
Epoch: 064  Loss: 562.815171 Train: 0.5725 Test: 0.5069 FPS: 10849 
Epoch: 065  Loss: 586.476496 Train: 0.5066 Test: 0.5363 FPS: 11055 
Epoch: 066  Loss: 576.469017 Train: 0.5022 Test: 0.4692 FPS: 10901 
Epoch: 067  Loss: 580.580128 Train: 0.4536 Test: 0.4521 FPS: 11095 
Epoch: 068  Loss: 568.678419 Train: 0.4454 Test: 0.4924 FPS: 11161 
Epoch: 069  Loss: 563.202991 Train: 0.5084 Test: 0.5353 FPS: 11187 
Epoch: 070  Loss: 541.059829 Train: 0.4722 Test: 0.4604 FPS: 11059 
Epoch: 071  Loss: 530.131410 Train: 0.4857 Test: 0.5301 FPS: 11054 
Epoch: 072  Loss: 553.978632 Train: 0.4937 Test: 0.4673 FPS: 11130 
Epoch: 073  Loss: 609.172009 Train: 0.5216 Test: 0.5888 FPS: 11148 
Epoch: 074  Loss: 537.426282 Train: 0.6663 Test: 0.6658 FPS: 10995 
Epoch: 075  Loss: 438.239316 Train: 0.6428 Test: 0.6775 FPS: 10941 
Epoch: 076  Loss: 431.096154 Train: 0.6441 Test: 0.6630 FPS: 10717 
Epoch: 077  Loss: 426.745726 Train: 0.6324 Test: 0.1801 FPS: 11051 S BEST 
Epoch: 078  Loss: 430.068376 Train: 0.5175 Test: 0.4741 FPS: 11029 
Epoch: 079  Loss: 323.815171 Train: 0.6776 Test: 0.8030 FPS: 11095 
Epoch: 080  Loss: 249.697650 Train: 0.6835 Test: 0.0961 FPS: 11152 S BEST 
Epoch: 081  Loss: 231.506410 Train: 0.5619 Test: 0.1086 FPS: 10831 
Epoch: 082  Loss: 216.550214 Train: 0.5785 Test: 0.6490 FPS: 10843 
Epoch: 083  Loss: 406.507479 Train: 0.4371 Test: 0.4544 FPS: 11176 
Epoch: 084  Loss: 355.727564 Train: 0.6156 Test: 0.7707 FPS: 11089 
Epoch: 085  Loss: 470.251068 Train: 0.6329 Test: 0.4461 FPS: 11101 
Epoch: 086  Loss: 476.791667 Train: 0.3931 Test: 0.2969 FPS: 10869 
Epoch: 087  Loss: 229.928419 Train: 0.1273 Test: 0.1066 FPS: 9491 
Epoch: 088  Loss: 177.666667 Train: 0.0903 Test: 0.0968 FPS: 10626 
Epoch: 089  Loss: 149.452991 Train: 0.0779 Test: 0.0851 FPS: 10962 S BEST 
Epoch: 090  Loss: 140.440171 Train: 0.0816 Test: 0.0540 FPS: 10465 S BEST 
Epoch: 091  Loss: 106.186966 Train: 0.0423 Test: 0.0471 FPS: 10582 S BEST 
Epoch: 092  Loss: nan Train: 0.3618 Test: 1.0000 FPS: 10897 
Epoch: 093  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10933 
Epoch: 094  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10910 
Epoch: 095  