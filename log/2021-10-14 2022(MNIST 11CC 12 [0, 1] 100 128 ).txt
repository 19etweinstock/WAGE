2021-10-14 20:22:46 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 12  # bit width of gradients
bitsE = 12 # bit width of errors

bitsR = 12  # bit width of randomizer

lr_schedule = [0,1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.000000
Epoch: 000  Loss: 606.688034 Train: 0.2885 Test: 0.2855 FPS: 7603 
Epoch: 001  Loss: 606.195513 Train: 0.2854 Test: 0.2855 FPS: 11732 
Epoch: 002  Loss: 605.643162 Train: 0.2836 Test: 0.2855 FPS: 11447 
Epoch: 003  Loss: 606.324786 Train: 0.2849 Test: 0.2855 FPS: 11686 
Epoch: 004  Loss: 605.936966 Train: 0.2895 Test: 0.2763 FPS: 11593 S BEST 
Epoch: 005  Loss: 604.487179 Train: 0.3467 Test: 0.3848 FPS: 10515 
Epoch: 006  Loss: 592.310897 Train: 0.3538 Test: 0.4060 FPS: 10655 
Epoch: 007  Loss: 597.498932 Train: 0.4333 Test: 0.4517 FPS: 11427 
Epoch: 008  Loss: 596.836538 Train: 0.4286 Test: 0.4346 FPS: 11483 
Epoch: 009  Loss: 586.146368 Train: 0.4330 Test: 0.4322 FPS: 11179 
Epoch: 010  Loss: 585.026709 Train: 0.4238 Test: 0.4471 FPS: 11384 
Epoch: 011  Loss: 596.076923 Train: 0.4784 Test: 0.5141 FPS: 11612 
Epoch: 012  Loss: 602.782051 Train: 0.4869 Test: 0.5053 FPS: 11476 
Epoch: 013  Loss: 601.364316 Train: 0.5080 Test: 0.5773 FPS: 11535 
Epoch: 014  Loss: 606.436966 Train: 0.5660 Test: 0.5588 FPS: 11141 
Epoch: 015  Loss: 609.181624 Train: 0.5863 Test: 0.6105 FPS: 11142 
Epoch: 016  Loss: 616.851496 Train: 0.6241 Test: 0.6305 FPS: 11485 
Epoch: 017  Loss: 618.879274 Train: 0.6406 Test: 0.5732 FPS: 11400 
Epoch: 018  Loss: 587.208333 Train: 0.5659 Test: 0.5897 FPS: 11547 
Epoch: 019  Loss: 562.966880 Train: 0.5601 Test: 0.6361 FPS: 11603 
Epoch: 020  Loss: 564.726496 Train: 0.5746 Test: 0.5827 FPS: 11382 
Epoch: 021  Loss: 577.740385 Train: 0.5966 Test: 0.5863 FPS: 11068 
Epoch: 022  Loss: 543.697650 Train: 0.5531 Test: 0.5233 FPS: 10890 
Epoch: 023  Loss: 531.335470 Train: 0.5385 Test: 0.5609 FPS: 10846 
Epoch: 024  Loss: 511.360043 Train: 0.5188 Test: 0.5628 FPS: 11136 
Epoch: 025  Loss: 477.214744 Train: 0.4944 Test: 0.5490 FPS: 11442 
Epoch: 026  Loss: 516.317308 Train: 0.5895 Test: 0.6289 FPS: 11507 
Epoch: 027  Loss: 533.448718 Train: 0.6418 Test: 0.6574 FPS: 11148 
Epoch: 028  Loss: 506.766026 Train: 0.5750 Test: 0.5552 FPS: 11363 
Epoch: 029  Loss: 459.131410 Train: 0.5830 Test: 0.6226 FPS: 11416 
Epoch: 030  Loss: 496.617521 Train: 0.5109 Test: 0.4742 FPS: 11509 
Epoch: 031  Loss: 481.130342 Train: 0.4859 Test: 0.4629 FPS: 11503 
Epoch: 032  Loss: 465.736111 Train: 0.5089 Test: 0.5701 FPS: 11496 
Epoch: 033  Loss: 441.316239 Train: 0.5328 Test: 0.4895 FPS: 11315 
Epoch: 034  Loss: 249.725427 Train: 0.1925 Test: 0.0635 FPS: 11514 S BEST 
Epoch: 035  Loss: 142.744658 Train: 0.0583 Test: 0.0503 FPS: 10370 S BEST 
Epoch: 036  Loss: 119.472222 Train: 0.0449 Test: 0.0407 FPS: 10529 S BEST 
Epoch: 037  Loss: nan Train: 0.3941 Test: 1.0000 FPS: 10326 
Epoch: 038  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10951 
Epoch: 039  