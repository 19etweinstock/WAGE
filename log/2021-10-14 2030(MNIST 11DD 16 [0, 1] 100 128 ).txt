2021-10-14 20:30:44 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.000000
Epoch: 000  Loss: 660.616453 Train: 0.5408 Test: 0.5432 FPS: 7787 
Epoch: 001  Loss: 661.709402 Train: 0.5449 Test: 0.5432 FPS: 12055 S BEST 
Epoch: 002  Loss: 660.039530 Train: 0.5380 Test: 0.5432 FPS: 10934 
Epoch: 003  Loss: 661.517094 Train: 0.5422 Test: 0.5432 FPS: 11393 
Epoch: 004  Loss: 660.768162 Train: 0.5416 Test: 0.5432 FPS: 11784 
Epoch: 005  Loss: 661.105769 Train: 0.5416 Test: 0.5432 FPS: 11658 
Epoch: 006  Loss: 660.053419 Train: 0.5386 Test: 0.5432 FPS: 11531 
Epoch: 007  Loss: 660.506410 Train: 0.5415 Test: 0.5430 FPS: 11831 S BEST 
Epoch: 008  Loss: 659.395299 Train: 0.5526 Test: 0.5511 FPS: 10642 
Epoch: 009  Loss: 653.563034 Train: 0.5502 Test: 0.5654 FPS: 10928 
Epoch: 010  Loss: 648.331197 Train: 0.5537 Test: 0.5104 FPS: 11630 S BEST 
Epoch: 011  Loss: 636.982906 Train: 0.5307 Test: 0.5491 FPS: 10697 
Epoch: 012  Loss: 637.181624 Train: 0.5567 Test: 0.5525 FPS: 10302 
Epoch: 013  Loss: 631.927350 Train: 0.5658 Test: 0.5851 FPS: 11530 
Epoch: 014  Loss: 633.231838 Train: 0.5759 Test: 0.5709 FPS: 11781 
Epoch: 015  Loss: 621.023504 Train: 0.5512 Test: 0.5181 FPS: 11651 
Epoch: 016  Loss: 614.445513 Train: 0.5481 Test: 0.5470 FPS: 11801 
Epoch: 017  Loss: 615.557692 Train: 0.5571 Test: 0.5502 FPS: 11705 
Epoch: 018  Loss: 616.320513 Train: 0.5660 Test: 0.5762 FPS: 11867 
Epoch: 019  Loss: 616.764957 Train: 0.5637 Test: 0.5656 FPS: 11716 
Epoch: 020  Loss: 616.709402 Train: 0.5645 Test: 0.5249 FPS: 11253 
Epoch: 021  Loss: 610.258547 Train: 0.5323 Test: 0.5083 FPS: 11486 S BEST 
Epoch: 022  Loss: 601.597222 Train: 0.4990 Test: 0.5192 FPS: 10262 
Epoch: 023  Loss: 591.840812 Train: 0.4758 Test: 0.4272 FPS: 10460 S BEST 
Epoch: 024  Loss: 592.026709 Train: 0.4932 Test: 0.5158 FPS: 10556 
Epoch: 025  Loss: 610.318376 Train: 0.5622 Test: 0.5704 FPS: 11259 
Epoch: 026  Loss: 618.864316 Train: 0.5880 Test: 0.5873 FPS: 11508 
Epoch: 027  Loss: 599.519231 Train: 0.5272 Test: 0.4617 FPS: 11810 
Epoch: 028  Loss: 585.170940 Train: 0.4738 Test: 0.4795 FPS: 11767 
Epoch: 029  Loss: 591.415598 Train: 0.5115 Test: 0.5665 FPS: 11461 
Epoch: 030  Loss: 594.606838 Train: 0.5671 Test: 0.5954 FPS: 11695 
Epoch: 031  Loss: 595.692308 Train: 0.5787 Test: 0.5511 FPS: 11737 
Epoch: 032  Loss: 588.324786 Train: 0.5475 Test: 0.5264 FPS: 11754 
Epoch: 033  Loss: 589.797009 Train: 0.5405 Test: 0.5149 FPS: 11781 
Epoch: 034  Loss: 598.595085 Train: 0.5603 Test: 0.5611 FPS: 11895 
Epoch: 035  Loss: 605.227564 Train: 0.5773 Test: 0.5856 FPS: 11751 
Epoch: 036  Loss: 589.987179 Train: 0.5501 Test: 0.5202 FPS: 11460 
Epoch: 037  Loss: 583.519231 Train: 0.5188 Test: 0.5052 FPS: 11577 
Epoch: 038  Loss: 569.255342 Train: 0.4842 Test: 0.4771 FPS: 11675 
Epoch: 039  Loss: 548.130342 Train: 0.4805 Test: 0.5515 FPS: 11723 
Epoch: 040  Loss: 536.770299 Train: 0.5084 Test: 0.5009 FPS: 11493 
Epoch: 041  Loss: 528.936966 Train: 0.4994 Test: 0.4932 FPS: 11707 
Epoch: 042  Loss: 521.557692 Train: 0.4641 Test: 0.4881 FPS: 11764 
Epoch: 043  Loss: 502.168803 Train: 0.4621 Test: 0.4974 FPS: 11626 
Epoch: 044  Loss: 499.615385 Train: 0.4875 Test: 0.4864 FPS: 11895 
Epoch: 045  Loss: 491.142094 Train: 0.5100 Test: 0.5345 FPS: 11705 
Epoch: 046  Loss: 494.039530 Train: 0.5287 Test: 0.5846 FPS: 10944 
Epoch: 047  Loss: 473.342949 Train: 0.5653 Test: 0.4853 FPS: 11679 
Epoch: 048  Loss: 482.620726 Train: 0.5879 Test: 0.6108 FPS: 11652 
Epoch: 049  Loss: 495.092949 Train: 0.6024 Test: 0.6295 FPS: 11273 
Epoch: 050  Loss: 493.308761 Train: 0.6381 Test: 0.6205 FPS: 11543 
Epoch: 051  Loss: 488.618590 Train: 0.6676 Test: 0.6501 FPS: 11740 
Epoch: 052  Loss: 490.668803 Train: 0.6511 Test: 0.6104 FPS: 11760 
Epoch: 053  Loss: 487.613248 Train: 0.6034 Test: 0.6753 FPS: 11816 
Epoch: 054  Loss: 427.610043 Train: 0.5765 Test: 0.3628 FPS: 11915 S BEST 
Epoch: 055  Loss: 431.454060 Train: 0.5968 Test: 0.6414 FPS: 10766 
Epoch: 056  Loss: 451.736111 Train: 0.5771 Test: 0.5929 FPS: 11004 
Epoch: 057  Loss: 430.079060 Train: 0.5590 Test: 0.5198 FPS: 11608 
Epoch: 058  Loss: 431.048077 Train: 0.5594 Test: 0.6080 FPS: 11586 
Epoch: 059  Loss: 449.925214 Train: 0.5377 Test: 0.5454 FPS: 11738 
Epoch: 060  Loss: 482.378205 Train: 0.4964 Test: 0.4641 FPS: 11683 
Epoch: 061  Loss: 486.916667 Train: 0.4597 Test: 0.4287 FPS: 11499 
Epoch: 062  Loss: 414.368590 Train: 0.3879 Test: 0.3272 FPS: 11344 S BEST 
Epoch: 063  Loss: 345.378205 Train: 0.3141 Test: 0.3347 FPS: 10657 
Epoch: 064  Loss: 349.886752 Train: 0.3209 Test: 0.2707 FPS: 10902 S BEST 
Epoch: 065  Loss: 339.662393 Train: 0.3056 Test: 0.2863 FPS: 11040 
Epoch: 066  Loss: 310.535256 Train: 0.2630 Test: 0.2552 FPS: 11254 S BEST 
Epoch: 067  Loss: 273.121795 Train: 0.2102 Test: 0.1788 FPS: 10923 S BEST 
Epoch: 068  Loss: 224.005342 Train: 0.1505 Test: 0.1522 FPS: 10847 S BEST 
Epoch: 069  Loss: 202.449786 Train: 0.1352 Test: 0.1328 FPS: 10908 S BEST 
Epoch: 070  Loss: 188.355769 Train: 0.1128 Test: 0.1263 FPS: 10992 S BEST 
Epoch: 071  Loss: 174.152778 Train: 0.1077 Test: 0.0998 FPS: 11003 S BEST 
Epoch: 072  Loss: 122.947650 Train: 0.0558 Test: 0.0292 FPS: 10898 S BEST 
Epoch: 073  Loss: nan Train: 0.3667 Test: 1.0000 FPS: 10699 
Epoch: 074  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11288 
Epoch: 075  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11787 
Epoch: 076  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11747 
Epoch: 077  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11730 
Epoch: 078  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11593 
Epoch: 079  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11790 
Epoch: 080  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11772 
Epoch: 081  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11744 
Epoch: 082  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11954 
Epoch: 083  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11748 
Epoch: 084  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11728 
Epoch: 085  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11454 
Epoch: 086  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11603 
Epoch: 087  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11735 
Epoch: 088  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11823 
Epoch: 089  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11782 
Epoch: 090  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11773 
Epoch: 091  