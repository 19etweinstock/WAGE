2021-10-14 21:07:54 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.15]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.150000
Epoch: 000  Loss: 726.620726 Train: 0.7525 Test: 0.7541 FPS: 7433 
Epoch: 001  Loss: 726.557692 Train: 0.7538 Test: 0.7541 FPS: 11297 S BEST 
Epoch: 002  Loss: 726.404915 Train: 0.7500 Test: 0.7541 FPS: 10532 
Epoch: 003  Loss: 726.840812 Train: 0.7534 Test: 0.7541 FPS: 10800 
Epoch: 004  Loss: 725.990385 Train: 0.7513 Test: 0.7541 FPS: 11515 
Epoch: 005  Loss: 727.148504 Train: 0.7548 Test: 0.7541 FPS: 11720 S BEST 
Epoch: 006  Loss: 727.151709 Train: 0.7557 Test: 0.7588 FPS: 10804 
Epoch: 007  Loss: 723.573718 Train: 0.7539 Test: 0.7503 FPS: 10842 S BEST 
Epoch: 008  Loss: 704.130342 Train: 0.7159 Test: 0.6718 FPS: 11576 S BEST 
Epoch: 009  Loss: 648.081197 Train: 0.5611 Test: 0.5607 FPS: 11052 S BEST 
Epoch: 010  Loss: 634.337607 Train: 0.5193 Test: 0.5342 FPS: 10920 S BEST 
Epoch: 011  Loss: 625.572650 Train: 0.5264 Test: 0.5122 FPS: 11048 S BEST 
Epoch: 012  Loss: 622.102564 Train: 0.5185 Test: 0.4952 FPS: 10712 S BEST 
Epoch: 013  Loss: 624.282051 Train: 0.5206 Test: 0.5188 FPS: 10491 
Epoch: 014  Loss: 621.204060 Train: 0.5136 Test: 0.5055 FPS: 10678 
Epoch: 015  Loss: 619.993590 Train: 0.5097 Test: 0.4660 FPS: 10842 S BEST 
Epoch: 016  Loss: 606.266026 Train: 0.4940 Test: 0.4946 FPS: 10358 
Epoch: 017  Loss: 603.626068 Train: 0.4885 Test: 0.5022 FPS: 10630 
Epoch: 018  Loss: 601.480769 Train: 0.4831 Test: 0.4998 FPS: 10753 
Epoch: 019  Loss: 603.191239 Train: 0.4921 Test: 0.4621 FPS: 11459 S BEST 
Epoch: 020  Loss: 602.537393 Train: 0.5239 Test: 0.5419 FPS: 10974 
Epoch: 021  Loss: 603.006410 Train: 0.5723 Test: 0.5636 FPS: 11272 
Epoch: 022  Loss: 594.967949 Train: 0.5645 Test: 0.5534 FPS: 10838 
Epoch: 023  Loss: 590.386752 Train: 0.5748 Test: 0.5874 FPS: 11624 
Epoch: 024  Loss: 596.274573 Train: 0.5827 Test: 0.5575 FPS: 11130 
Epoch: 025  Loss: 586.222222 Train: 0.5238 Test: 0.5104 FPS: 11117 
Epoch: 026  Loss: 584.118590 Train: 0.5129 Test: 0.5004 FPS: 10656 
Epoch: 027  Loss: 575.832265 Train: 0.4682 Test: 0.4769 FPS: 11403 
Epoch: 028  Loss: 572.512821 Train: 0.4594 Test: 0.4642 FPS: 11430 
Epoch: 029  Loss: 576.910256 Train: 0.4925 Test: 0.5344 FPS: 10197 
Epoch: 030  Loss: 591.069444 Train: 0.5372 Test: 0.5289 FPS: 10832 
Epoch: 031  Loss: 584.442308 Train: 0.5505 Test: 0.5654 FPS: 10865 
Epoch: 032  Loss: 571.192308 Train: 0.5284 Test: 0.5115 FPS: 10986 
Epoch: 033  Loss: 540.950855 Train: 0.4720 Test: 0.4940 FPS: 10746 
Epoch: 034  Loss: 528.048077 Train: 0.5111 Test: 0.5644 FPS: 10777 
Epoch: 035  Loss: 526.469017 Train: 0.5569 Test: 0.5397 FPS: 11115 
Epoch: 036  Loss: 504.060897 Train: 0.5586 Test: 0.5779 FPS: 10666 
Epoch: 037  Loss: 485.777778 Train: 0.5910 Test: 0.5557 FPS: 11258 
Epoch: 038  Loss: 485.482906 Train: 0.6045 Test: 0.6445 FPS: 11131 
Epoch: 039  Loss: 456.696581 Train: 0.6373 Test: 0.6199 FPS: 11094 
Epoch: 040  Loss: 499.945513 Train: 0.6448 Test: 0.6276 FPS: 11275 
Epoch: 041  Loss: 514.787393 Train: 0.6272 Test: 0.6124 FPS: 11069 
Epoch: 042  Loss: 527.204060 Train: 0.5514 Test: 0.5642 FPS: 11446 
Epoch: 043  Loss: 519.600427 Train: 0.5422 Test: 0.5732 FPS: 11372 
Epoch: 044  Loss: 512.733974 Train: 0.5469 Test: 0.6093 FPS: 11275 
Epoch: 045  Loss: 506.452991 Train: 0.5752 Test: 0.5884 FPS: 10925 
Epoch: 046  Loss: 454.690171 Train: 0.5823 Test: 0.6341 FPS: 10900 
Epoch: 047  Loss: 407.693376 Train: 0.5826 Test: 0.6456 FPS: 11313 
Epoch: 048  Loss: 413.789530 Train: 0.5984 Test: 0.6452 FPS: 10735 
Epoch: 049  Loss: 408.002137 Train: 0.5904 Test: 0.3390 FPS: 11213 S BEST 
Epoch: 050  Loss: 352.039530 Train: 0.5403 Test: 0.6601 FPS: 10421 
Epoch: 051  Loss: 332.211538 Train: 0.5794 Test: 0.7600 FPS: 10269 
Epoch: 052  Loss: 427.076923 Train: 0.6158 Test: 0.4578 FPS: 10567 
Epoch: 053  Loss: 468.064103 Train: 0.5558 Test: 0.5848 FPS: 11525 
Epoch: 054  Loss: 457.580128 Train: 0.5423 Test: 0.4335 FPS: 11541 
Epoch: 055  Loss: 457.117521 Train: 0.5655 Test: 0.6673 FPS: 11233 
Epoch: 056  Loss: 435.576923 Train: 0.5972 Test: 0.4878 FPS: 11608 
Epoch: 057  Loss: 417.252137 Train: 0.6147 Test: 0.5659 FPS: 11528 
Epoch: 058  Loss: 405.235043 Train: 0.6423 Test: 0.5763 FPS: 11205 
Epoch: 059  Loss: 395.314103 Train: 0.6391 Test: 0.6442 FPS: 11297 
Epoch: 060  Loss: 400.466880 Train: 0.6387 Test: 0.5582 FPS: 10926 
Epoch: 061  Loss: 360.592949 Train: 0.6551 Test: 0.7327 FPS: 10478 
Epoch: 062  Loss: 402.961538 Train: 0.5939 Test: 0.5631 FPS: 10890 
Epoch: 063  Loss: 465.492521 Train: 0.5635 Test: 0.5498 FPS: 11271 
Epoch: 064  Loss: 443.630342 Train: 0.5802 Test: 0.5291 FPS: 11301 
Epoch: 065  Loss: 438.791667 Train: 0.5471 Test: 0.6151 FPS: 11083 
Epoch: 066  Loss: 343.298077 Train: 0.4503 Test: 0.2510 FPS: 10472 S BEST 
Epoch: 067  Loss: 256.497863 Train: 0.5914 Test: 0.8406 FPS: 10076 
Epoch: 068  Loss: 232.529915 Train: 0.5504 Test: 0.7690 FPS: 9711 
Epoch: 069  Loss: 183.289530 Train: 0.5092 Test: 0.8689 FPS: 11133 
Epoch: 070  Loss: 185.601496 Train: 0.5365 Test: 0.8604 FPS: 10914 
Epoch: 071  Loss: 179.288462 Train: 0.4891 Test: 0.0286 FPS: 11084 S BEST 
Epoch: 072  Loss: 220.432692 Train: 0.4621 Test: 0.3722 FPS: 8874 
Epoch: 073  Loss: 441.936966 Train: 0.3973 Test: 0.4409 FPS: 9444 
Epoch: 074  Loss: 428.025641 Train: 0.4415 Test: 0.5205 FPS: 10795 
Epoch: 075  Loss: 384.748932 Train: 0.4216 Test: 0.2626 FPS: 11235 
Epoch: 076  Loss: 277.377137 Train: 0.2740 Test: 0.2255 FPS: 11070 
Epoch: 077  Loss: 223.834402 Train: 0.2282 Test: 0.1502 FPS: 10743 
Epoch: 078  Loss: 222.720085 Train: 0.2038 Test: 0.2039 FPS: 10882 
Epoch: 079  Loss: 197.274573 Train: 0.1658 Test: 0.1647 FPS: 11146 
Epoch: 080  Loss: 179.654915 Train: 0.1328 Test: 0.0631 FPS: 10640 
Epoch: 081  Loss: 128.002137 Train: 0.0516 Test: 0.0374 FPS: 11419 
Epoch: 082  Loss: 118.364316 Train: 0.0399 Test: 0.0423 FPS: 11027 
Epoch: 083  Loss: nan Train: 0.0563 Test: 1.0000 FPS: 10785 
Epoch: 084  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 10180 
Epoch: 085  