2021-11-03 21:48:59 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/2021-10-25 1108(MNIST 11DD 16 [0, 1.1] 100 128 ).tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 5] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 5, 8] Scale:8
W: /device:GPU:0 Fc/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 1125 FC: 26280 Total: 27405
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 5] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 5, 8] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [128, 120] Scale:8
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 661.775641 Train: 0.5494 Test: 0.5846 FPS: 7589 
Epoch: 001  Loss: 661.447650 Train: 0.5493 Test: 0.5846 FPS: 11631 
Epoch: 002  Loss: 662.337607 Train: 0.5494 Test: 0.5846 FPS: 11784 
Epoch: 003  Loss: 661.634615 Train: 0.5496 Test: 0.5846 FPS: 11416 S BEST 
Epoch: 004  Loss: 663.108974 Train: 0.5548 Test: 0.5846 FPS: 10521 S BEST 
Epoch: 005  Loss: 661.753205 Train: 0.5487 Test: 0.5846 FPS: 10853 
Epoch: 006  Loss: 662.151709 Train: 0.5510 Test: 0.5846 FPS: 11687 
Epoch: 007  Loss: 656.264957 Train: 0.5520 Test: 0.6113 FPS: 11804 
Epoch: 008  Loss: 642.601496 Train: 0.5726 Test: 0.5872 FPS: 11601 
Epoch: 009  Loss: 634.660256 Train: 0.5529 Test: 0.5871 FPS: 11710 
Epoch: 010  Loss: 626.632479 Train: 0.5295 Test: 0.5602 FPS: 11472 S BEST 
Epoch: 011  Loss: 612.605769 Train: 0.4800 Test: 0.5088 FPS: 11928 S BEST 
Epoch: 012  Loss: 611.977564 Train: 0.4693 Test: 0.5287 FPS: 11226 
Epoch: 013  Loss: 602.513889 Train: 0.4768 Test: 0.5051 FPS: 11004 S BEST 
Epoch: 014  Loss: 602.112179 Train: 0.5259 Test: 0.5872 FPS: 10638 
Epoch: 015  Loss: 600.623932 Train: 0.5472 Test: 0.5365 FPS: 11815 
Epoch: 016  Loss: 613.513889 Train: 0.5848 Test: 0.5956 FPS: 11345 
Epoch: 017  Loss: 620.149573 Train: 0.6061 Test: 0.5984 FPS: 11681 
Epoch: 018  Loss: 618.895299 Train: 0.6070 Test: 0.6100 FPS: 12041 
Epoch: 019  Loss: 624.332265 Train: 0.6312 Test: 0.6048 FPS: 11482 
Epoch: 020  Loss: 616.979701 Train: 0.6213 Test: 0.5860 FPS: 11972 
Epoch: 021  Loss: 612.237179 Train: 0.6168 Test: 0.5429 FPS: 11826 
Epoch: 022  Loss: 602.241453 Train: 0.5892 Test: 0.5583 FPS: 11879 
Epoch: 023  Loss: 595.322650 Train: 0.5672 Test: 0.5285 FPS: 11910 
Epoch: 024  Loss: 569.224359 Train: 0.5028 Test: 0.4239 FPS: 10853 S BEST 
Epoch: 025  Loss: 551.519231 Train: 0.4394 Test: 0.4484 FPS: 10372 
Epoch: 026  Loss: 553.196581 Train: 0.4836 Test: 0.4654 FPS: 10983 
Epoch: 027  Loss: 494.519231 Train: 0.5648 Test: 0.4912 FPS: 11377 
Epoch: 028  Loss: 576.567308 Train: 0.4903 Test: 0.4639 FPS: 11633 
Epoch: 029  Loss: 582.529915 Train: 0.4420 Test: 0.5093 FPS: 11550 
Epoch: 030  Loss: 462.241453 Train: 0.6127 Test: 0.5363 FPS: 11855 
Epoch: 031  Loss: 485.751068 Train: 0.6430 Test: 0.5212 FPS: 11735 
Epoch: 032  Loss: 559.121795 Train: 0.5950 Test: 0.5350 FPS: 11780 
Epoch: 033  Loss: 579.647436 Train: 0.5718 Test: 0.5169 FPS: 11384 
Epoch: 034  Loss: 566.106838 Train: 0.5520 Test: 0.5832 FPS: 11110 
Epoch: 035  Loss: 577.026709 Train: 0.5124 Test: 0.5792 FPS: 11069 
Epoch: 036  Loss: 575.449786 Train: 0.5273 Test: 0.4950 FPS: 11334 
Epoch: 037  Loss: 528.161325 Train: 0.5325 Test: 0.5275 FPS: 11418 
Epoch: 038  Loss: 525.766026 Train: 0.4627 Test: 0.5842 FPS: 11429 
Epoch: 039  Loss: 438.910256 Train: 0.5859 Test: 0.5967 FPS: 11698 
Epoch: 040  Loss: 525.877137 Train: 0.5777 Test: 0.5833 FPS: 11292 
Epoch: 041  Loss: 604.543803 Train: 0.6220 Test: 0.5913 FPS: 10884 
Epoch: 042  Loss: 596.978632 Train: 0.5794 Test: 0.5581 FPS: 11624 
Epoch: 043  Loss: 536.220085 Train: 0.5981 Test: 0.5438 FPS: 11732 
Epoch: 044  Loss: 412.020299 Train: 0.6307 Test: 0.5190 FPS: 11427 
Epoch: 045  Loss: 358.069444 Train: 0.6601 Test: 0.5777 FPS: 11788 
Epoch: 046  Loss: 373.902778 Train: 0.6197 Test: 0.5920 FPS: 11501 
Epoch: 047  Loss: 470.972222 Train: 0.6090 Test: 0.5290 FPS: 11391 
Epoch: 048  Loss: 523.870726 Train: 0.6167 Test: 0.4928 FPS: 11766 
Epoch: 049  Loss: 536.555556 Train: 0.6195 Test: 0.5267 FPS: 11404 
Epoch: 050  Loss: 509.450855 Train: 0.6214 Test: 0.4508 FPS: 11522 
Epoch: 051  Loss: 430.648504 Train: 0.6604 Test: 0.5028 FPS: 11613 
Epoch: 052  Loss: 196.091880 Train: 0.1272 Test: 0.5331 FPS: 11806 
Epoch: 053  Loss: 105.366453 Train: 0.0451 Test: 0.5248 FPS: 11721 
Epoch: 054  Loss: 100.691239 Train: 0.0437 Test: 0.5610 FPS: 11685 
Epoch: 055  Loss: 101.683761 Train: 0.0468 Test: 0.5807 FPS: 11972 
Epoch: 056  Loss: 96.361111 Train: 0.0388 Test: 0.4341 FPS: 11814 
Epoch: 057  Loss: 96.963675 Train: 0.0465 Test: 0.5227 FPS: 11797 
Epoch: 058  Loss: 116.302350 Train: 0.0744 Test: 0.4712 FPS: 11516 
Epoch: 059  Loss: 122.231838 Train: 0.0856 Test: 0.4914 FPS: 11299 
Epoch: 060  Loss: nan Train: 0.4705 Test: 1.0000 FPS: 11251 
Epoch: 061  Loss: nan Train: 1.0000 Test: 1.0000 FPS: 11236 
Epoch: 062  