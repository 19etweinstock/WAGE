2021-10-14 21:16:34 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 13  # bit width of gradients
bitsE = 13 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 680.789530 Train: 0.5511 Test: 0.5523 FPS: 7340 
Epoch: 001  Loss: 680.019231 Train: 0.5507 Test: 0.5523 FPS: 11107 
Epoch: 002  Loss: 679.651709 Train: 0.5460 Test: 0.5523 FPS: 11317 
Epoch: 003  Loss: 680.194444 Train: 0.5508 Test: 0.5523 FPS: 11754 
Epoch: 004  Loss: 680.304487 Train: 0.5504 Test: 0.5523 FPS: 11838 
Epoch: 005  Loss: 680.121795 Train: 0.5492 Test: 0.5523 FPS: 11625 
Epoch: 006  Loss: 679.775641 Train: 0.5470 Test: 0.5523 FPS: 11839 
Epoch: 007  Loss: 680.310897 Train: 0.5518 Test: 0.5475 FPS: 11721 S BEST 
Epoch: 008  Loss: 674.153846 Train: 0.5602 Test: 0.5567 FPS: 10849 
Epoch: 009  Loss: 636.307692 Train: 0.4934 Test: 0.4455 FPS: 10142 S BEST 
Epoch: 010  Loss: 613.325855 Train: 0.4299 Test: 0.4320 FPS: 10896 S BEST 
Epoch: 011  Loss: 621.237179 Train: 0.4805 Test: 0.5309 FPS: 10906 
Epoch: 012  Loss: 628.962607 Train: 0.5448 Test: 0.5920 FPS: 11106 
Epoch: 013  Loss: 629.199786 Train: 0.5491 Test: 0.5919 FPS: 11594 
Epoch: 014  Loss: 630.056624 Train: 0.5545 Test: 0.5720 FPS: 11109 
Epoch: 015  Loss: 629.949786 Train: 0.5568 Test: 0.5868 FPS: 11401 
Epoch: 016  Loss: 630.126068 Train: 0.5662 Test: 0.5344 FPS: 11683 
Epoch: 017  Loss: 632.589744 Train: 0.5795 Test: 0.5393 FPS: 11407 
Epoch: 018  Loss: 632.963675 Train: 0.5812 Test: 0.5822 FPS: 11824 
Epoch: 019  Loss: 630.526709 Train: 0.5782 Test: 0.6168 FPS: 11586 
Epoch: 020  Loss: 630.044872 Train: 0.5832 Test: 0.5827 FPS: 11573 
Epoch: 021  Loss: 617.807692 Train: 0.5614 Test: 0.5627 FPS: 11153 
Epoch: 022  Loss: 587.483974 Train: 0.4812 Test: 0.5036 FPS: 10763 
Epoch: 023  Loss: 592.028846 Train: 0.5179 Test: 0.5074 FPS: 11676 
Epoch: 024  Loss: 589.167735 Train: 0.5170 Test: 0.4321 FPS: 11429 
Epoch: 025  Loss: 576.057692 Train: 0.4739 Test: 0.4664 FPS: 8988 
Epoch: 026  Loss: 576.673077 Train: 0.4881 Test: 0.5112 FPS: 9098 
Epoch: 027  Loss: 588.178419 Train: 0.5535 Test: 0.5827 FPS: 10573 
Epoch: 028  Loss: 580.233974 Train: 0.5508 Test: 0.5594 FPS: 10953 
Epoch: 029  Loss: 560.408120 Train: 0.5212 Test: 0.5301 FPS: 11031 
Epoch: 030  Loss: 547.595085 Train: 0.5228 Test: 0.5166 FPS: 10860 
Epoch: 031  Loss: 532.951923 Train: 0.4940 Test: 0.4253 FPS: 10268 S BEST 
Epoch: 032  Loss: 522.230769 Train: 0.4774 Test: 0.5448 FPS: 9943 
Epoch: 033  Loss: 521.907051 Train: 0.5213 Test: 0.4836 FPS: 10001 
Epoch: 034  Loss: 513.494658 Train: 0.5711 Test: 0.5758 FPS: 10536 
Epoch: 035  Loss: 517.059829 Train: 0.5572 Test: 0.5412 FPS: 10868 
Epoch: 036  Loss: 511.659188 Train: 0.5739 Test: 0.5449 FPS: 11311 
Epoch: 037  Loss: 507.204060 Train: 0.5517 Test: 0.5113 FPS: 10669 
Epoch: 038  Loss: 505.825855 Train: 0.5698 Test: 0.5937 FPS: 10910 
Epoch: 039  Loss: 505.639957 Train: 0.6035 Test: 0.6188 FPS: 10656 
Epoch: 040  Loss: 496.954060 Train: 0.5829 Test: 0.5632 FPS: 10648 
Epoch: 041  Loss: 477.236111 Train: 0.5863 Test: 0.5823 FPS: 11032 
Epoch: 042  Loss: 445.717949 Train: 0.5786 Test: 0.5740 FPS: 10708 
Epoch: 043  Loss: 497.861111 Train: 0.5883 Test: 0.5327 FPS: 10198 
Epoch: 044  Loss: 500.598291 Train: 0.6330 Test: 0.6165 FPS: 10727 
Epoch: 045  Loss: 501.942308 Train: 0.6501 Test: 0.6545 FPS: 11145 
Epoch: 046  Loss: 507.537393 Train: 0.6374 Test: 0.6119 FPS: 11032 
Epoch: 047  Loss: 512.962607 Train: 0.6105 Test: 0.6397 FPS: 10091 
Epoch: 048  Loss: 498.914530 Train: 0.5804 Test: 0.6443 FPS: 10538 
Epoch: 049  Loss: 501.024573 Train: 0.5891 Test: 0.6147 FPS: 10923 
Epoch: 050  Loss: 478.801282 Train: 0.5466 Test: 0.5907 FPS: 11227 
Epoch: 051  Loss: 443.197650 Train: 0.5937 Test: 0.5750 FPS: 11430 
Epoch: 052  Loss: 425.090812 Train: 0.5895 Test: 0.6388 FPS: 11271 
Epoch: 053  Loss: 439.036325 Train: 0.5778 Test: 0.6010 FPS: 11537 
Epoch: 054  Loss: 472.669872 Train: 0.5427 Test: 0.5501 FPS: 11380 
Epoch: 055  Loss: 463.597222 Train: 0.5471 Test: 0.5036 FPS: 11314 
Epoch: 056  Loss: 455.634615 Train: 0.5329 Test: 0.4986 FPS: 11471 
Epoch: 057  Loss: 429.110043 Train: 0.5063 Test: 0.5845 FPS: 11229 
Epoch: 058  Loss: 418.683761 Train: 0.5334 Test: 0.5696 FPS: 11327 
Epoch: 059  Loss: 386.339744 Train: 0.5569 Test: 0.4826 FPS: 11189 
Epoch: 060  Loss: 401.295940 Train: 0.5533 Test: 0.5331 FPS: 11330 
Epoch: 061  Loss: 409.160256 Train: 0.6270 Test: 0.6689 FPS: 11383 
Epoch: 062  Loss: 425.494658 Train: 0.6841 Test: 0.5520 FPS: 10995 
Epoch: 063  Loss: 423.714744 Train: 0.7027 Test: 0.6397 FPS: 10485 
Epoch: 064  Loss: 379.221154 Train: 0.6580 Test: 0.1778 FPS: 11224 S BEST 
Epoch: 065  Loss: 324.876068 Train: 0.6454 Test: 0.7838 FPS: 10542 
Epoch: 066  Loss: 330.837607 Train: 0.6750 Test: 0.7210 FPS: 10082 
Epoch: 067  Loss: 271.747863 Train: 0.6507 Test: 0.6343 FPS: 10842 
Epoch: 068  Loss: 303.971154 Train: 0.6179 Test: 0.6067 FPS: 11036 
Epoch: 069  Loss: 394.133547 Train: 0.5993 Test: 0.5475 FPS: 10998 
Epoch: 070  Loss: 422.733974 Train: 0.6015 Test: 0.5611 FPS: 11442 
Epoch: 071  Loss: 445.763889 Train: 0.5474 Test: 0.5183 FPS: 11327 
Epoch: 072  Loss: 410.550214 Train: 0.3893 Test: 0.2653 FPS: 11386 
Epoch: 073  Loss: 330.685897 Train: 0.2122 Test: 0.1964 FPS: 11370 
Epoch: 074  Loss: 283.842949 Train: 0.1506 Test: 0.1266 FPS: 11299 S BEST 
Epoch: 075  Loss: 266.601496 Train: 0.1235 Test: 0.1397 FPS: 10523 
Epoch: 076  Loss: 227.252137 Train: 0.1063 Test: 0.0958 FPS: 10313 S BEST 
Epoch: 077  Loss: 188.160256 Train: 0.0930 Test: 0.0737 FPS: 10565 S BEST 
Epoch: 078  Loss: 147.685897 Train: 0.0610 Test: 0.0591 FPS: 10663 S BEST 
Epoch: 079  Loss: 133.552350 Train: 0.0533 Test: 0.0433 FPS: 10647 S BEST 
Epoch: 080  Loss: 128.852564 Train: 0.0494 Test: 0.0494 FPS: 10636 
Epoch: 081  Loss: nan Train: 0.0398 Test: 1.0000 FPS: 10790 
Epoch: 082  