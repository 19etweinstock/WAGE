2021-10-18 10:31:21 

import time
import tensorflow as tf

tf.compat.v1.disable_eager_execution()
tf.compat.v1.disable_v2_behavior()

bitsW = 1  # bit width of weights
bitsA = 1  # bit width of activations
bitsG = 14  # bit width of gradients
bitsE = 14 # bit width of errors

bitsR = 16  # bit width of randomizer

lr_schedule = [0,1.1]

Epoch = 100

batchSize = 128
use_batch_norm = False

dataSet = 'MNIST'  # 'MNIST','SVHN','CIFAR10', 'ILSVRC2012'

def upper(str):
    return str.upper()

batch_text = 'batch norm' if use_batch_norm else ''

Time = time.strftime('%Y-%m-%d %H%M', time.localtime())
Notes = f'{dataSet} {bitsW}{bitsA}{upper(hex(bitsG)[2:])}{upper(hex(bitsE)[2:])} {bitsR} {lr_schedule} {Epoch} {batchSize} {batch_text}'
# Notes = 'lenet5 2888'
# Notes = 'alexnet 28CC'

GPU = [0]
validNum = 0


loadModel = None
# loadModel = '../model/' + '2017-10-26' + '(' + 'vgg7 2888' + ')' + '.tf'
# saveModel = None
saveModel = '../model/' + Time + '(' + Notes + ')' + '.tf'


lr = tf.compat.v1.Variable(initial_value=0., trainable=False, name='lr', dtype=tf.float32)
# lr_schedule = [0, 8, 200, 1,250,1./8,300,0]
# lr_schedule = [0, 32, 40, 32./8, 60, 32./64, 80, 0]
L2 = 0

lossFunc = 'SSE'
# lossFunc = tf.losses.softmax_cross_entropy
optimizer = tf.compat.v1.train.GradientDescentOptimizer(1)  # lr is controlled in Quantize.G

# shared variables, defined by other files
seed = None
sess = None
W_scale = []

def upper(str):
    return str.upper()

W: /device:GPU:0 Conv/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc/fc2/ [84, 10] Scale:8
CONV: 2550 FC: 41640 Total: 44190
W: /device:GPU:0 Conv_1/conv0/ [5, 5, 1, 6] Scale:4
W: /device:GPU:0 Conv_1/conv1/ [5, 5, 6, 16] Scale:8
W: /device:GPU:0 Fc_1/fc0/ [256, 120] Scale:16
W: /device:GPU:0 Fc_1/fc1/ [120, 84] Scale:8
W: /device:GPU:0 Fc_1/fc2/ [84, 10] Scale:8

Optimization Start!

lr: 0.000000 -> 1.100000
Epoch: 000  Loss: 676.722222 Train: 0.5945 Test: 0.5971 FPS: 4365 
Epoch: 001  Loss: 678.325855 Train: 0.6000 Test: 0.5971 FPS: 12013 S BEST 
Epoch: 002  Loss: 676.832265 Train: 0.5967 Test: 0.5971 FPS: 11042 
Epoch: 003  Loss: 678.052350 Train: 0.5996 Test: 0.5971 FPS: 12154 
Epoch: 004  Loss: 677.544872 Train: 0.5967 Test: 0.5971 FPS: 12302 
Epoch: 005  Loss: 678.167735 Train: 0.5996 Test: 0.5971 FPS: 12319 
Epoch: 006  Loss: 677.395299 Train: 0.5960 Test: 0.5971 FPS: 12205 
Epoch: 007  Loss: 676.987179 Train: 0.5956 Test: 0.5971 FPS: 12063 
Epoch: 008  Loss: 677.398504 Train: 0.5982 Test: 0.5971 FPS: 11493 
Epoch: 009  Loss: 677.870726 Train: 0.5980 Test: 0.5971 FPS: 11864 
Epoch: 010  Loss: 677.884615 Train: 0.5993 Test: 0.5971 FPS: 11968 
Epoch: 011  Loss: 678.063034 Train: 0.5989 Test: 0.5971 FPS: 12008 
Epoch: 012  Loss: 677.273504 Train: 0.5958 Test: 0.5971 FPS: 11818 
Epoch: 013  Loss: 677.170940 Train: 0.5982 Test: 0.5971 FPS: 11092 
Epoch: 014  Loss: 677.579060 Train: 0.5965 Test: 0.5971 FPS: 11651 
Epoch: 015  Loss: 677.833333 Train: 0.5984 Test: 0.5971 FPS: 11225 
Epoch: 016  Loss: 671.833333 Train: 0.5868 Test: 0.5435 FPS: 11938 S BEST 
Epoch: 017  Loss: 644.205128 Train: 0.5277 Test: 0.5298 FPS: 10655 S BEST 
Epoch: 018  Loss: 642.473291 Train: 0.5511 Test: 0.5712 FPS: 11252 
Epoch: 019  Loss: 647.239316 Train: 0.5862 Test: 0.5546 FPS: 11945 
Epoch: 020  Loss: 644.173077 Train: 0.5775 Test: 0.6048 FPS: 11625 
Epoch: 021  Loss: 648.350427 Train: 0.6049 Test: 0.5865 FPS: 11774 
Epoch: 022  Loss: 646.612179 Train: 0.6001 Test: 0.6035 FPS: 11682 
Epoch: 023  Loss: 634.955128 Train: 0.5718 Test: 0.5425 FPS: 11893 
Epoch: 024  Loss: 632.934829 Train: 0.5851 Test: 0.5598 FPS: 11675 
Epoch: 025  Loss: 632.044872 Train: 0.5831 Test: 0.5492 FPS: 11757 
Epoch: 026  Loss: 633.098291 Train: 0.5870 Test: 0.6126 FPS: 11785 
Epoch: 027  Loss: 641.990385 Train: 0.6257 Test: 0.6188 FPS: 11846 
Epoch: 028  Loss: 641.952991 Train: 0.6258 Test: 0.6196 FPS: 11842 
Epoch: 029  Loss: 642.929487 Train: 0.6223 Test: 0.6130 FPS: 11804 
Epoch: 030  Loss: 644.722222 Train: 0.6267 Test: 0.6230 FPS: 11745 
Epoch: 031  Loss: 645.574786 Train: 0.6327 Test: 0.6136 FPS: 11377 
Epoch: 032  Loss: 645.457265 Train: 0.6289 Test: 0.6346 FPS: 11597 
Epoch: 033  Loss: 644.386752 Train: 0.6264 Test: 0.6151 FPS: 11294 
Epoch: 034  Loss: 645.536325 Train: 0.6328 Test: 0.6258 FPS: 11682 
Epoch: 035  Loss: 647.837607 Train: 0.6398 Test: 0.6330 FPS: 11627 
Epoch: 036  Loss: 640.697650 Train: 0.6339 Test: 0.6456 FPS: 11599 
Epoch: 037  Loss: 640.528846 Train: 0.6335 Test: 0.6299 FPS: 11540 
Epoch: 038  Loss: 639.691239 Train: 0.6321 Test: 0.6320 FPS: 11686 
Epoch: 039  Loss: 640.882479 Train: 0.6245 Test: 0.6100 FPS: 11563 
Epoch: 040  Loss: 622.318376 Train: 0.5743 Test: 0.5572 FPS: 11624 
Epoch: 041  Loss: 605.065171 Train: 0.5297 Test: 0.5177 FPS: 11610 S BEST 
Epoch: 042  Loss: 602.117521 Train: 0.5151 Test: 0.5240 FPS: 10406 
Epoch: 043  Loss: 600.354701 Train: 0.5053 Test: 0.4800 FPS: 11356 S BEST 
Epoch: 044  Loss: 600.131410 Train: 0.5098 Test: 0.4933 FPS: 10571 
Epoch: 045  Loss: 599.092949 Train: 0.5078 Test: 0.5071 FPS: 11235 
Epoch: 046  Loss: 598.982906 Train: 0.5069 Test: 0.5059 FPS: 11374 
Epoch: 047  Loss: 599.989316 Train: 0.4896 Test: 0.5101 FPS: 11479 
Epoch: 048  Loss: 600.096154 Train: 0.4887 Test: 0.4904 FPS: 11344 
Epoch: 049  Loss: 598.876068 Train: 0.4856 Test: 0.4625 FPS: 11163 S BEST 
Epoch: 050  Loss: 598.663462 Train: 0.4895 Test: 0.4787 FPS: 10275 
Epoch: 051  Loss: 599.559829 Train: 0.4903 Test: 0.4690 FPS: 11121 
Epoch: 052  Loss: 601.883547 Train: 0.5143 Test: 0.5517 FPS: 11517 
Epoch: 053  Loss: 612.077991 Train: 0.5885 Test: 0.5659 FPS: 11212 
Epoch: 054  Loss: 609.180556 Train: 0.5775 Test: 0.5938 FPS: 11564 
Epoch: 055  Loss: 594.866453 Train: 0.5200 Test: 0.5021 FPS: 11582 
Epoch: 056  Loss: 589.822650 Train: 0.4938 Test: 0.4658 FPS: 11410 
Epoch: 057  Loss: 585.387821 Train: 0.4599 Test: 0.4986 FPS: 11156 
Epoch: 058  Loss: 585.623932 Train: 0.4632 Test: 0.4683 FPS: 11294 
Epoch: 059  Loss: 581.243590 Train: 0.4620 Test: 0.4614 FPS: 11681 S BEST 
Epoch: 060  Loss: 580.877137 Train: 0.4870 Test: 0.4762 FPS: 10435 
Epoch: 061  Loss: 580.667735 Train: 0.4975 Test: 0.4879 FPS: 10592 
Epoch: 062  Loss: 578.451923 Train: 0.5026 Test: 0.5521 FPS: 10777 
Epoch: 063  Loss: 585.007479 Train: 0.5451 Test: 0.5467 FPS: 11422 
Epoch: 064  Loss: 582.126068 Train: 0.5552 Test: 0.5986 FPS: 11657 
Epoch: 065  Loss: 603.445513 Train: 0.6178 Test: 0.6107 FPS: 11526 
Epoch: 066  Loss: 604.608974 Train: 0.6245 Test: 0.6126 FPS: 11465 
Epoch: 067  Loss: 591.061966 Train: 0.6020 Test: 0.5888 FPS: 10846 
Epoch: 068  Loss: 583.263889 Train: 0.5953 Test: 0.5978 FPS: 11087 
Epoch: 069  Loss: 581.060897 Train: 0.5952 Test: 0.6039 FPS: 11332 
Epoch: 070  Loss: 584.192308 Train: 0.6082 Test: 0.6118 FPS: 11023 
Epoch: 071  Loss: 589.149573 Train: 0.6198 Test: 0.5858 FPS: 11493 
Epoch: 072  Loss: 590.547009 Train: 0.6026 Test: 0.6046 FPS: 11278 
Epoch: 073  Loss: 599.952991 Train: 0.6410 Test: 0.6398 FPS: 11618 
Epoch: 074  Loss: 594.452991 Train: 0.6354 Test: 0.6113 FPS: 11500 
Epoch: 075  Loss: 586.737179 Train: 0.6219 Test: 0.5960 FPS: 11519 
Epoch: 076  Loss: 580.995726 Train: 0.5900 Test: 0.5857 FPS: 11410 
Epoch: 077  Loss: 582.982906 Train: 0.5846 Test: 0.5726 FPS: 11465 
Epoch: 078  Loss: 585.478632 Train: 0.5728 Test: 0.5292 FPS: 11478 
Epoch: 079  Loss: 580.215812 Train: 0.5541 Test: 0.5535 FPS: 11456 
Epoch: 080  Loss: 582.219017 Train: 0.5515 Test: 0.5542 FPS: 11548 
Epoch: 081  Loss: 581.642094 Train: 0.5565 Test: 0.5781 FPS: 11586 
Epoch: 082  Loss: 557.191239 Train: 0.5328 Test: 0.5386 FPS: 11111 
Epoch: 083  Loss: 548.338675 Train: 0.5120 Test: 0.5187 FPS: 11432 
Epoch: 084  Loss: 548.483974 Train: 0.4935 Test: 0.4801 FPS: 11526 
Epoch: 085  Loss: 553.034188 Train: 0.4990 Test: 0.4972 FPS: 11436 
Epoch: 086  Loss: 552.495726 Train: 0.5179 Test: 0.5431 FPS: 11522 
Epoch: 087  Loss: 550.403846 Train: 0.5212 Test: 0.4769 FPS: 11511 
Epoch: 088  Loss: 544.933761 Train: 0.5196 Test: 0.5731 FPS: 11509 
Epoch: 089  Loss: 544.456197 Train: 0.5177 Test: 0.5627 FPS: 11403 
Epoch: 090  Loss: 540.472222 Train: 0.5094 Test: 0.4844 FPS: 11596 
Epoch: 091  Loss: 530.740385 Train: 0.5095 Test: 0.5158 FPS: 11570 
Epoch: 092  Loss: 521.944444 Train: 0.4923 Test: 0.4638 FPS: 11436 
Epoch: 093  Loss: 520.394231 Train: 0.5067 Test: 0.4821 FPS: 11446 
Epoch: 094  Loss: 517.091880 Train: 0.5005 Test: 0.5076 FPS: 11584 
Epoch: 095  Loss: 517.455128 Train: 0.5165 Test: 0.6011 FPS: 10872 
Epoch: 096  Loss: 517.738248 Train: 0.5716 Test: 0.6016 FPS: 10451 
Epoch: 097  Loss: 516.639957 Train: 0.5793 Test: 0.5953 FPS: 10024 
Epoch: 098  Loss: 502.362179 Train: 0.5585 Test: 0.5819 FPS: 10275 
Epoch: 099  Loss: 484.210470 Train: 0.5764 Test: 0.4241 FPS: 10227 S BEST 
